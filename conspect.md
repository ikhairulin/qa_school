Конспект

1.      25.08 в 19:30 – Теория тестирования производительности, преподаватель – Иванцов Е.В.

 2.      30.08 – начинаем ставить БД Oracle, ссылочку пришлем.

 3.      01.09 в 19:00 – БД, SQL, преподаватель – Полуян А.В.

 4.      08.09 в 19:00 – Инструмент НТ MF LoadRunner, видеоурок, преподаватель – Жданов А.Н.

 5.      11.09 в 19:00 - Сессия "вопрос- ответ" по инструментам НТ MF LoadRunner, преподаватель – Колбин С.Е.

 6.      15.09 в 19:00 – Правила написания заглушек, преподаватель – Жданов А.Н.

 7.      18.09 в 19:00 - Сессия "вопрос- ответ" по заглушкам, преподаватель – Жданов А.Н.



# Цели нагрузочного тестирования (виды нагрузочных тестов)
1. Тест на определение максимальной производительности
- Нагрузка 20% - 40% - 60% - 80% - 100% от целевого максимума (исходя из требований)
Если поставить сразу 100% то будет слишком много дефектов, и невозможно будет выделить проблемы. Ступеньки нужны чтобы вытаскивать ошибки по одной.
- После 100% надо еще раз прогнать этот же тест. Нагрузка на 100%. Это называется подтверждение максимальной производительности.
Бывает так что результаты меняются.
Еще раз 100% - это целевой максимум системы который берется из требований и который есть в *профиле нагрузки*
Правильно назвать этот тест "Тестом дотаскивания системы до целевого максимума", потому что в процессе выявляются ошибки, с которыми система просто не доберется до цели
2. Тест надежности (стабильности)
Тест проводится длительной время на не максимальной нагрузке. Достаточно 80%. Проводится обычно в течение 24 часов.
Тест нужен для выявления утечек памяти, накапливающихся ошибок
3. Тест отказоустойчивости
Проверка работы системы, если отваливается какой-то модуль или интеграция. Интеграция это связь с другой системой. Обязательно подразумевается получение ответа от смежной системы. Операции, которые завязаны на искомую интеграцию, должны не работать, а остальные модули должны продолжать работать с требуемым уровнем качества.
Проверяется только ПО. Не железо.
4. Тест на выявление узких мест
Повторение любого из предыдущих тестов для раскапывания дефекта


Следующие два теста обычно не применяются
5. Тест на воспроизведение проблем промышленной среды
6. Подбор оптимального КТС (комплекса технических средств)

Еще тесты
7. Стресс-тест
200-300% от целевого максимума
~~Тест сам по себе бредовый, так как есть требования и пляшем от них~~
8. Объемный тест
Нагрузочный тест на увеличенной базе данных. База раздувается раза в три-пять и потом прогоняется тест
~~Когда база вырастет тогда и будем тестировать~~

*** Основная цель - это выявление дефектов производительности ***


**Этапы нагрузочного тестирования**

0. Знакомство с задачей. погружение в систему.
- Говорим заказчику "Тестовый стенд должен быть"

1. Разработка методики нагрузочного тестирования
- Профиль нагрузки - Подать нужные операции с нужной интенсивностью нагрузки
- Критерии успешности
- Какие тесты надо проводить

2. Средства нагрузочного тестирования
- Скрипты
- Эмуляторы
- Если обезличивается база, то средства обезличивания данных
- Подготовка стенда, если дают. Обычно это делает администратор тестового стенда

3. Проведение тестов согласно методике

4. Оформление отчета по тестированию (c обязательным указанием выявленных дефектов которые идут в пром, по согласованию с командой)


## Тестовый стенд

*** Тестовый стенд *** должен соответствовать промышленному на 100% по параметрам производительности (процессор, память, диски)
Программные компоненты тоже должны соответствовать (операционная система, драйвера, устройство сетей, их топология, протокол, пропускная способность, архитектура и ПО).

Если оборудование тестового стенда не соответствует на 100% применяется *сравнительно-нагрузочное тестирование*, (это работает только для очередного релиза уже существующей системы):
- берем старый релиз который хорошо работает на промышленном стенде и ставим его на плохой (несоответствующий тестовый стенд)
- подаем требуемую нагрузку на старый релиз на "плохом" тестовом стенде.
- мы увидим что какие-то операции выполняются так же как и на промышленном стенде, а какие-то выполняются медленнее. Для тех операций которые выполняются медленнее мы можем скорректировать время выполнения этих операций
- таким образом подав целевую нагрузку на старый релиз на "плохом" стенде мы меняем критерии успешности НТ для ряда операций (у которых ухудшились показатели)
Проблема сравнительно-нагрузочного тестирования в том, что ухудшение показателей в новом релизе может произойти и на промышленном стенде, так же как и на нашем "плохом" тестовом.

Сравнительное нагрузочное тестирование не спасает от борьбы с *** Лже-дефектами ***
СНТ сильно увеличивает количество работы (в 2,5 раз) так как тестов надо проводить в два раза больше. На старом релизе и на новом, плюс корректировка критериев успешности. Если не корректировать критерии, то каждое увеличение времени на операцию будет приводить к работе над дефектом, который может быть и не дефектом вовсе.
Сам факт проведения СНТ обязательно прописывается в методике.


**Профиль нагрузки**

"В крупную клетку" это таблица из двух колонок.
Название операции | Интенсивность операции

Операции которые попадают основную нагрузку их всегда не много.
Если система выполняет 2000 операций, то в профиле обычно около 50 операций.
Операций в профиле всегда не много. Примерно 95/5

*Операции которые попадают в профиль нагрузки:*
1. Критичные операции (основные наиболее важные операции, без которых система не имеет смысла)
2. Операции создающие основную нагрузку (по статистике, либо от аналитиков)
3. Тяжеловесные операции (Подготовка годового отчета)

В зависимости от проектной ситуации профиль нагрузки составляется следующим образом:
1. Инцидент в проме - что-то случилось с рабочей системой
 (значит система работает в промышленной среде, есть статистика с прома, и ее можно использовать. Можно отобрать операции создающие основную нагрузку и сразу видно их интенсивность, критичные и тяжеловесные берутся от аналитиков)
2. Рождение системы (статистики нет, надо полагаться на прогнозы аналитиков, проблема в том, что обычно в этих прогнозах много ошибок. Какие операции критичные и какие тяжеловесные мы тоже узнаем от аналитиков)
3. Доработка системы или новый релиз (по старым операциям берем статистику с прома, по новым - у аналитиков)

У аналитиков мы берем:
- интенсивность операций,
- время отклика операций,
- какие операции критичные, какие больше всего нагружают и какие тяжеловесные

Интенсивность операции = Количество операций в единицу времени (для каждой операции своя)
I = Q / t

Пример
Операция выполняется с интенсивностью - тысяча операций в секунду
Длительность операции - 2 секунды
Для проверки интенсивности необходимо 2000 пользователей

**Разделы методики НТ**
1. Профиль нагрузки
2. Описание промышленного стенда
3. Описание тестового стенда
4. Описание источников для профиля нагрузки (статистика с прома, прогнозы аналитиков)
5. Описание средств НТ (Обезличивание и подготовка тестовой базы, скрипты, эмуляторы, мониторинг)
6. Выполняемые нагрузочные тесты (Тест надежности, какие тесты отказоустойчивости мы будем выполнять, будем ли выполнять тесты на определение максимума)
7. Критерии успешности НТ(SLA от бизнеса - соглашение между заказчиком услуги и ее исполнителем касательно уровня качества предоставления услуг)
8. Шаблон отчета (возможно)
9. Ограничения (Несоответствие стендов, например)

Методика согласовывается с проектной командой и аналитиками

Некорректное выполнение операций - это не НТ. Это функциональное тестирование

**Критерии успешности НТ (SLA от бизнеса)**
1. Время отклика (время выполнения операции)
2. Допустимый процент ошибок (если не соблюден процент, то это дефект)
3. Утилизация аппаратных ресурсов. (Процессор, память, диски. Пороги их загруженности при работе системы и нагрузке)

**Подготовка и обезличивание базы данных**
- Важно не разрушить связи между разными таблицами базы данных, для этого необходимо разобраться в ее структуре;
- Включает подготовку большой базы данных (счет идет на терабайты);
- Бывают исключение когда не нужно грузить систему с большой базой данных (по договоренности с командой). В этом случае мы готовим пул данных (минимальное наполнение базы данных для корректной работы системы)

*** Скрипты ***
Заставляют систему выполнять операции. Один скрипт - одна операция.

*** Эмулятор *** - программа программа имитирующая ответ от смежной системы. Также называется заглушкой.
Ключевые параметры эмуляторов (Берем у аналитиков):
1. Вариативность ответа. Это соотношение ответов эквивалентное прому (необходимо воспроизвести логику взаимодействия системы со сторонними на 100%)
2. Задержка ответа.

Для подачи нагрузки используются так называемые *нагрузочные станции*. Они должны быть предусмотрены в проекте заранее.

**Проведение НТ**
1. Запуски тестов согласно методике НТ
2. Запуски тестов на локализацию узких мест
3. *Анализ БД* и работы приложения
4. Выработка рекомендаций по устранению узких мест

**Отчет**
1. Выжимка результатов запусков НТ
2. Описание дефектов
3. Рекомендации по устранению дефектов производительности



# Нагрузочное тестирование. Занятие по LoadRunner

1. Разработка скриптов
- нулевой уровень - записываем действия (например, добавить товар в корзину)
- почистить скрипт ( по принципу: оставляем web_url, submit_data и start_transaction, end_transaction)
- корреляция - добавить в скрипт куки и другие данные от сервера
- параметризация - добавить разных пользователей и разные действия (не один и тот же товар в корзину). Для этих целей есть справочники товаров и справочники пользователей
- отладка скрипта (прогнать скрипт и убедиться что "товары были куплены", в скрипте расставляем ассерты для проверки ответов сервера)

2. Настройка сценария нагрузочного тестирования
- задать интенсивность выполнения скриптов (например, поиск товара - 700 операций в минуту, покупка товара - 1000)
- настройка генераторов - (ресурсы с которых подается нагрузка, с разных машин и с разных стран, для правдоподобности тестирования)

3. Запуск тестов и мониторинг
- количество или интенсивность выполнения операций (проверить что выполняется именно то количество операций которое задал)
- время выполнения (отклика) операции
- количество ошибок
- утилизация аппаратных ресурсов - ЦПУ (очередь запросов в ЦПУ, если очередь большая и начинает расти, то это значит ресурс исчерпан), память, диски, количество коллизий в пакетах по сети, её текущая пропускная способность, время отклика на операции ввода-вывода у дисков, количество "ИОпсов" (IO - input-output), очередь на диск (на запись и чтение)
- метрики технологического стека - внутренние системы мониторинга систем, например СУБД или системы управления сервером. Узкое место может быть в конфигурации серверного приложения (например ограничение по количеству потоков), или в базе данных (если идет полное сканирование таблиц при какой-либо из операций, возможно там не настроено индексирование). У каждого стека обычно есть Performance Tuning, в котором расписано какие метрики мониторить и на что обратить внимание
- профилирование кода (какой именно код "жрет" много ресурсов)

4. Анализ результатов
- соответствие профилю нагрузки
- корреляция поведения системы с графиками утилизации ресурсов и техстека
- вывод - соответствует ли система заявленным требованиям


## Свойства заглушек
1. Вариативность ответов (данные берем из реальной статистики)
- вариативность по контенту
- время отклика
- процент ошибок
- пропускная способность