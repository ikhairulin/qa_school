"use strict";(self.webpackChunk_mail_octavius=self.webpackChunk_mail_octavius||[]).push([[923],{71331:function(t,e,i){i.r(e),i.d(e,{CallsManager:function(){return T}});var n,o=i(18440),l=i.n(o),r=i(39783),s=i.n(r),a=i(92042),u=i.n(a),c=i(13624),h=i.n(c),d=i(85271),f=i(50542),p=i(63062),g=i(92203),v=i(93610),_=i(43353),m=i(90557),w=(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i))t[i]=e[i]})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),y=function(){return(y=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var o in e=arguments[i])if(Object.prototype.hasOwnProperty.call(e,o))t[o]=e[o];return t}).apply(this,arguments)},b=["calls:invite","calls:invitenew"],T=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return w(e,t),e.prototype.getComponentsSpec=function(){return{router:{class:h()},letter:{lazy:m.FV,events:b},"contextmenu-message":{class:v.Z,events:b},"dropdown-actions":{class:_.Z,events:b},"compose-dropdown":{class:g.Z,events:b}}},e.prototype.handleEvent=function(t){var e=t.type,i=t.details.model,n=this.get("router.model.letter"),o={type:e}.type.split(":").pop();if("invitenew"===o)return this.doAction(o,s().getSafe());else return this.doAction(o,i||n)},e.prototype.doAction=function(t,e){if(!e)return!1;if(e instanceof u()&&e.get("messages.length"))e=e.getExpandMessage();var i="invitenew"===t?{mode:"new",subject:d.Z.getSubject()}:{mode:"replyall",model:e};return f.default.open(i),d.Z.createRoom().then((function(t){var e=d.Z.getTemplate(t);if(f.default.isComposeActive())f.default.insertHtml(e);else f.default.open(y(y({},i),{body:e,additionalOptions:{prefilledBody:!0}}))})).catch((function(t){if("ratelimit"===t)p.default.error({text:i18n("Достигнут лимит создания звонков. Попробуйте позже.")},"compose-notify");else p.default.error({text:i18n("Не удалось создать ссылку на звонок")},"compose-notify")})),!1},e}(l().Mediator);e.default=l().Mediator.createFromClass("calls-manager",T)},86088:function(t,e,i){i.r(e),i.d(e,{getNextBlinkingTitle:function(){return y}});var n,o=i(19275),l=i(21211),r=i(89629),s=i.n(r),a=i(18440),u=i.n(a),c=i(54844),h=i(13624),d=i.n(h),f=i(85271),p=i(56928),g=(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i))t[i]=e[i]})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),v=document.title||i18n("Почта Mail.ru"),_=function(){function t(t,e){this._switched=!1;var i=document.querySelector(t),n=i&&i.getAttribute("href");this._el=i,this._href=n,this._defaultHref=n,this._switchedHref=e,this._switched=!1}return t.prototype._createIconElement=function(t){var e=this._el;if(e){for(var i=document.createElement("LINK"),n=0,o=e.attributes;n<o.length;n++){var l=o[n];if("href"===l.name)i.setAttribute("href",t);else i.setAttribute(l.name,l.value)}return i}},t.prototype.switch=function(t){if(l.DYNAMIC_FAVICON)if(this._switched!==t)if(this._switched=t,this._href=this._switched?this._switchedHref:this._defaultHref,this._el.parentNode&&this._el.parentNode.removeChild(this._el),this._el=this._createIconElement(this._href),this._el)document.head.appendChild(this._el)},t}(),m=function(t){function e(){var e=t.call(this)||this;return e._blinkingInterval=null,e._timeoutId=null,e._blinkingInProcess=!1,e._titles={original:"",custom:""},e._iconSwitchers=[new _('link[rel="icon"][sizes="16x16"]',"".concat(o.Z.get("faviconURL"),"/16-fav_mail_unread.png")),new _('link[rel="icon"][sizes="24x24"]',"".concat(o.Z.get("faviconURL"),"/24-fav_mail_unread.png")),new _('link[rel="icon"][sizes="32x32"]',"".concat(o.Z.get("faviconURL"),"/32-fav_mail_unread.png")),new _('link[rel="icon"][sizes="48x48"]',"".concat(o.Z.get("faviconURL"),"/48-fav_mail_unread.png"))],e}return g(e,t),e.prototype.start=function(t){if(this._titles.original=t.originalTitle,this._titles.custom=t.customTitle,this._blinkingInterval=t.timeout,this._blinkingInProcess=!0,t.enableIconSwitch)this._iconSwitchers.forEach((function(t){return t.switch(!0)}));this._blinkingStep()},Object.defineProperty(e.prototype,"blinkingInProcess",{get:function(){return this._blinkingInProcess},enumerable:!1,configurable:!0}),e.prototype.update=function(t){this._titles.original=t.originalTitle,this._titles.custom=t.customTitle,this._blinkingInterval=t.timeout,this._iconSwitchers.forEach((function(e){return e.switch(!!t.enableIconSwitch)}))},e.prototype.stop=function(){this._blinkingInProcess=!1,this._iconSwitchers.forEach((function(t){return t.switch(!1)})),this.emit("update",{title:this._titles.original}),clearTimeout(this._timeoutId)},e.prototype._getTitleToShow=function(){return document.title===this._titles.original?this._titles.custom:this._titles.original},e.prototype._blinkingStep=function(){this.emit("update",{title:this._getTitleToShow()}),this._timeoutId=window.setTimeout(this._blinkingStep.bind(this),this._blinkingInterval)},e}(s()),w={calls:null,message:null,folder:null},y=function(t){return[t.calls,t.message].find((function(t){return null!==t}))||null};e.default=u().Mediator.create("page-title",{defaults:function(){this.register(this.blinker=new m),this.register(f.Z),this.updateFolderTitle=this.updateFolderTitle.bind(this)},components:{router:{class:d(),events:["route"],handleEvent:"handleRoute"},"unread-notifier":{class:p.Z,events:["update"],handleEvent:"handleNotifier"},blinker:{class:m,events:["update"],handleEvent:"setTitle"},callsService:{class:f.X,events:["update"],handleEvent:"handleCall"}},updateFolderTitle:function(t){if(t&&t.target){var e=t.target,i=e.get("messages_unread")?i18n("({unreadCount}) {folderName} - {defaultTitle}",{unreadCount:e.get("messages_unread"),folderName:e.get("name"),defaultTitle:v}):i18n("{folderName} - {defaultTitle}",{folderName:e.get("name"),defaultTitle:v});w.folder={title:i},this.setNextTitle()}},handleRoute:function(t){if(void 0===t)t=null;if(t)w.folder={title:this.getTitleFromEvent(t)},this.setNextTitle()},handleNotifier:function(t){if(t){var e=t.timeout,i=t.count,n=this.getTitleByUnreadMessages(i);w.message={title:n,timeout:e}}else w.message=null;this.setNextTitle()},handleCall:function(t){var e=t.action,i=t.text;if(l.CALL_TITLE_BLINK_INTERVAL){if("start"===e){var n=i+i18n(" - {defaultTitle}",{defaultTitle:v});w.calls={title:n,timeout:l.CALL_TITLE_BLINK_INTERVAL}}else if("end"===e)w.calls=null;this.setNextTitle()}},setNextTitle:function(){var t=y(w);if(c.Z.isSafari&&t&&t===w.calls)return this.blinker.stop(),void this.setTitle({title:t.title});if(!t){if(this.blinker.blinkingInProcess)this.blinker.stop();if(!w.folder)this.setTitle({title:v});else this.setTitle({title:w.folder.title})}else{var e={timeout:t.timeout,customTitle:t.title,enableIconSwitch:t===w.message,originalTitle:w.folder.title||v};this.blinker.blinkingInProcess?this.blinker.update(e):this.blinker.start(e)}},setTitle:function(t){var e=t.title;document.title=e},getTitleFromEvent:function(t){if(this.folder)this.folder.off("change",this.updateFolderTitle),this.folder=null;if(!t.target||!t.target.model)return v;var e,i=t.target.model;switch(i.route.id){case"#letters":if(i.folder)e=i.folder.get("messages_unread")?i18n("({unreadCount}) {folderName}",{unreadCount:i.folder.get("messages_unread"),folderName:i.folder.get("name")}):i.folder.get("name"),i.folder.on("change",this.updateFolderTitle),this.folder=i.folder;break;case"#search":e=i18n("Поиск");break;case"#attachment":e=i.attachment&&i.attachment.get("name")}return e?i18n("{title} - {defaultTitle}",{"unsafe-title":e,defaultTitle:v}):v},getTitleByUnreadMessages:function(t){return i18n.plural(t,[i18n("{count} новых писем",{count:t}),i18n("{count} новое письмо",{count:t}),i18n("{count} новых письма",{count:t})])}})},80720:function(t,e,i){i.r(e),i.d(e,{WelcomeBlockManager:function(){return O}});var n,o=i(17717),l=i.n(o),r=i(21211),s=i(18440),a=i.n(s),u=i(22469),c=i(75705),h=i(72727),d=i(96387),f=i(4872),p=i.n(f),g=i(39057),v=i(13624),_=i.n(v),m=i(93286),w=i(56706),y=i(35056),b=i(87401),T=i(82997),E=(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i))t[i]=e[i]})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});var O=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.pollingWeatherPid=null,e.canShowChecked=!1,e}return E(e,t),e.prototype.getComponentsSpec=function(){return{router:{class:_(),events:["routeend"],handleEvent:"handleRouteEvent"},"dataset-letters":{events:[u.X.NewRange]},dataset:{class:w.Z},"list-letter-welcome":{class:y.Z,events:[y.z.MOUNT,y.z.HIDE]},"list-letter-welcome-suggestions":{class:T.Z,events:[T.z.SuggestionClick],handleEvent:"handleMarusiaEvent"},"list-letter-welcome-dropdown-actions":{class:b.Z,events:[b.z.PIN,b.z.SELECT_GEO,b.z.SNOOZE]}}},e.prototype.handleMarusiaEvent=function(t){if(!(e=t).details||!e.details.hasOwnProperty("skill"))return!1;else return t.details.skill,!1;var e},e.prototype.handleRouteEvent=function(){var t=this.get("router");if(t&&this.isVisible()){if(!(t.route.is("#letters")||"3pane"===t.model.uiLayout.type&&t.model.uiLayout.support3pane&&t.route.is("#read-letter"))||t.route.params.folder!==p().INBOX)this.hide(),(0,m.ZP)(["ll-wlcm","hide-on","route"])}},e.prototype.handleEvent=function(t){var e,i,n,o,l=this.get("router");switch(t.type){case u.X.NewRange:var s=t.details.start;if(this.isVisible()&&(null===(e=null==l?void 0:l.route)||void 0===e?void 0:e.params.folder)===p().INBOX&&s>r.WELCOME_BLOCK_SCROLL_HIDE_THRESHOLD)this.hide(),(0,m.ZP)(["ll-wlcm","hide-on","scroll"]);break;case y.z.MOUNT:if(!this.canShowChecked)if(this.canShowChecked=!0,this.canShow())this.show(),(0,m.ZP)(["ll-wlcm","can-show"]);else(0,m.ZP)(["ll-wlcm","cannot-show"]);if(null===(i=this.getModel())||void 0===i?void 0:i.is("visible"))this.startPollingWeather();if(null===(n=this.getModel())||void 0===n?void 0:n.is("withGreeting"))this.delayedHideGreeting();break;case y.z.SHOW:if(null===(o=this.getModel())||void 0===o?void 0:o.is("visible"))this.startPollingWeather();break;case y.z.HIDE:this.stopPollingWeather();break;case b.z.PIN:break;case b.z.SELECT_GEO:(0,h.default)(r.SELECT_GEO_URL+"?from=mailwelcome");break;case b.z.SNOOZE:this.hide(!0),(0,m.ZP)(["ll-wlcm","hide-on","snooze"])}return!1},e.prototype.startPollingWeather=function(){var t=this;if(!this.pollingWeatherPid)this.fetchWeather(),this.pollingWeatherPid=window.setInterval((function(){t.fetchWeather()}),1e3*r.WELCOME_BLOCK_UPDATE_WEATHER_INTERVAL)},e.prototype.stopPollingWeather=function(){window.clearInterval(this.pollingWeatherPid),this.pollingWeatherPid=null},e.prototype.delayedHideGreeting=function(){var t=this;window.setTimeout((function(){var e;null===(e=t.getModel())||void 0===e||e.set("withGreeting",!1)}),1e3*r.WELCOME_BLOCK_HIDE_GREETING_TIMEOUT)},e.prototype.fetchWeather=function(){var t=this;d.Z.getSlot("t1189").then((function(e){var i=t.getModel();null==i||i.set("weatherData",e)}))},e.prototype.getFlag=function(){return l().get("welcome-block")},e.prototype.isSnoozed=function(){return this.getFlag().getCount("show")%2==1},e.prototype.getModel=function(){return g.Z.all[0]},e.prototype.updateDataset=function(){var t=this;setTimeout((function(){var e;null===(e=t.get("dataset"))||void 0===e||e.updateItems()}))},e.prototype.canShow=function(){var t=this.getFlag().getTime(),e=this.isSnoozed()?r.WELCOME_BLOCK_SNOOZE_INTERVAL:r.WELCOME_BLOCK_SHOW_INTERVAL;return(0,c.V)()>t+e},e.prototype.isVisible=function(){var t;return null===(t=this.getModel())||void 0===t?void 0:t.is("visible")},e.prototype.show=function(){var t,e=this.isVisible();if(null===(t=this.getModel())||void 0===t||t.set("visible",!0),this.updateDataset(),!e){var i=this.getFlag(),n=this.isSnoozed();i.save({time:!0,hit:n})}},e.prototype.hide=function(t){var e;if(void 0===t)t=!1;if(this.isVisible()){null===(e=this.getModel())||void 0===e||e.set("visible",!1),this.updateDataset();var i=this.getFlag(),n=t&&!this.isSnoozed();i.save({time:!0,hit:n})}},e}(a().Mediator);e.default=a().Mediator.createFromClass("welcome-block-manager",O)}}]);