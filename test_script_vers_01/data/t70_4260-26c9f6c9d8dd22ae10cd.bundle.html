(self.webpackChunk_mail_octavius=self.webpackChunk_mail_octavius||[]).push([[4260,4824],{77598:function(e,t,o){var i,a;i=[o(18440)],void 0===(a=function(e){return e.smartParse(e.__FEAST_TEMPLATE__`<div>
	<fn:var name="visible" value="{attrs.items.length > 0}"/>
	<fn:var name="collapsedCnt" value="{attrs.items.length - (attrs.active ? 1 : 0)}"/>
	<fn:var name="rise" value="{attrs.rise}"/>

	<bem:mod name="hidden" test="!visible"/>
	<bem:mod name="fullscreen" test="attrs.fullscreen"/>
	<bem:mod name="rise" test="rise"/>

	<bem:mod name="animate-open" test="attrs['animate-open']"/>
	<bem:mod name="animate-close" test="attrs['animate-close']"/>
	<bem:mod name="animate-expand" test="attrs['animate-expand']"/>
	<bem:mod name="animate-collapse" test="attrs['animate-collapse']"/>

	<bem:mod name="show-mobile-footer" test="attrs['show-mobile-footer']"/>

	<bem:mod name="new-toolbar" test="_this.useNewToolbar()"/>

	<fn:if test="visible">
		<b:dimmer fn:if="attrs.active"
				  remit:click="window-collapse"
				  event:details="false"
		/>

		<fn:for data="attrs.items" as="item">
			<b:compose-app
					use:mediator="compose-manager addressbook-manager themes-manager"
					key="compose-{item.formData.uid}"
					id="{'compose-' + item.formData.uid}"
					form="{item.formData}"
					window-mode="{attrs.active == item.formData.uid ? 'window' : 'collapsed'}"
					expand-status="{attrs.active == item.formData.uid && attrs['expand-status']}"
					router="{attrs.router}"
					priority="{item.formData.get('priority')}"
					receipt="{item.formData.get('receipt')}"
					remind="{item.formData.get('remind')}"
					sendDate="{item.formData.get('send_date')}"
					collectors="{_this._getCollectors()}"
					aliases="{_this._getAliases()}"
					adaptive="{attrs.adaptive}"
					fullscreen="{attrs.fullscreen}"
					mobile-xxs="{attrs['mobile-xxs']}"
					ponymode="{attrs.ponymode}"
					support-extend="{attrs['support-extend']}"
					extended="{attrs.extended}"
					compose-options="{item.additionalOptions}"
					autosend="{item.autosend}"
					saving="{item.formData.isSaving}"
					is-drag-and-drop="{item.isDragAndDrop}"
					drag-and-drop-item="{item.dragAndDropItem}"
					remit:open="window-open"
					remit:close="window-close"
					remit:collapse="window-collapse"
					remit:extend="window-extend"
					remit:autosave="letter-autosave"
					remit:savetemplate="letter-savetemplate"
					remit:exceedmaxsize="letter-exceedmaxsize"
			/>
		</fn:for>

		<b:compose-collapsed
				fn:if="collapsedCnt"
				items="{_this.getCollapsed(attrs.items)}"
				multiple="{false}"
				active-mobile="{attrs.active && attrs.overlap}"
				compact="{_this.isCompactCollapsed()}"
				above-paginator="{_this.isAbovePaginator() && !_this.isCompactCollapsed()}"
				use:mediator:byname="layout-manager routes-manager"
		/>
	</fn:if>

	<div bem:elem="notify"
		 qa:id="compose-notify-stack"
		 qa:state="rise:{rise}">
		<b:notify-stack ref="compose-notify" id="compose-notify" fixed />
	</div>
</div>
`,"./app/ui-block/compose-windows/compose-windows.html")}.apply(t,i))||(e.exports=a)},44824:function(e,t,o){"use strict";o.r(t);var i=o(90557),a=o(39783),s=o.n(a),n=o(77917),r=function(e,t,o){if(o||2===arguments.length)for(var i,a=0,s=t.length;a<s;a++)if(i||!(a in t)){if(!i)i=Array.prototype.slice.call(t,0,a);i[a]=t[a]}return e.concat(i||Array.prototype.slice.call(t))},c={checkOnMissingAttach:function(e){if(e.get("source.forward")||e.attachments.length)return Promise.resolve(!1);else return(0,i.HP)().then((function(t){return t.hasAttachment(c.getEnteredText(e.get("body.html")))}))},checkOnRettachToReply:function(e){var t=this,o=e.get("source.reply");if(!o)return Promise.resolve({});var i=e.get("folder_id");return s().findOne({id:o,folder_id:i}).then((function(o){var i=t._hasNewEmails(o,e),a=t._hasAttachToReattach(o);return{hasNewAttach:i&&a,source:o}}))},getEnteredText:function(e){var t=document.createElement("div");return t.innerHTML=e,Array.prototype.forEach.call(t.querySelectorAll((0,n.selector)("blockquote")),(function(e){e.parentNode&&e.parentNode.removeChild(e)})),Array.prototype.forEach.call(t.querySelectorAll((0,n.selector)("br")),(function(e){if(e.parentNode)e.parentNode.insertBefore(document.createTextNode("\n"),e),e.parentNode.removeChild(e)})),t.innerHTML},_hasNewEmails:function(e,t){var o=e.get("correspondents"),i=r(r(r(r([],o.from,!0),o.to,!0),o.cc,!0),o.bcc,!0).map((function(e){return e.email})),a=t.get("correspondents");return r(r(r([],a.to,!0),a.cc,!0),a.bcc,!0).map((function(e){return e.email})).some((function(e){return!i.includes(e)}))},_hasAttachToReattach:function(e){var t=e.get("attaches.list"),o=["text/calendar","application/ics"],i=new RegExp(/.ics$/);return t.some((function(e){return!o.includes(e.get("content_type"))&&!i.test(e.get("name"))}))}};t.default=c},44260:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return W}});var i=o(63876),a=o.n(i),s=o(21528),n=o(60033),r=o.n(n),c=o(19275),l=o(54498),d=o(99150),u=o(21211),f=o(18440),m=o(77598);var h=o(72727),p={Alt:1,AltGraph:2,CapsLock:3,Control:4,Fn:5,Shift:6,Enter:7,Tab:8,Space:9,ArrowDown:10,ArrowLeft:11,ArrowRight:12,ArrowUp:13,End:14,Home:15,PageDown:16,PageUp:17,Escape:18,Backspace:19,Clear:20,Delete:21},v={" ":"Space",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Esc:"Escape",Del:"Delete"},g={passive:!0,capture:!0};var _=new class{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.limit,o=void 0===t?u.COMPOSE_SEND_USER_TRACK_CONF[0]:t,i=e.trackMouseInterval,a=void 0===i?u.COMPOSE_SEND_USER_TRACK_CONF[1]:i;this.limit=o,this.trackMouseInterval=a,this.reset(),this.trackMouse=this.trackMouse.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onClick=this.onClick.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}reset(){this.composes={},this.active={},this.lastPointerSpeed=0,this.lastPointerPositionX=0,this.lastPointerPositionY=0,this.mouseTrackLastEventTimestamp=0,this.currentPointerPositionX=0,this.currentPointerPositionY=0,this.trackMouseIntervalObj=null,this.mouseCaptured=!1,this.started=!1}addEvent(e,t,o){var i=this.composes[e];if(i&&this.active[e]){var a=Date.now(),s=Math.max(a-i.lastEventTimestamp,0);if(i.lastEventTimestamp=a,i.events.push([t,s,...o].join("|")),i.events.length>this.limit)i.events.shift()}}hasComposes(){return Object.keys(this.active).reduce((e,t)=>t?e+1:e,0)>0}addEvents(e,t){Object.keys(this.active).forEach(o=>{this.addEvent(o,e,t)})}serialize(e){var t=this.composes[e];if(!t)return"";else return t.events.join(";")}trackMouse(){var e=Date.now();if(this.mouseCaptured){var t=Math.max(e-this.mouseTrackLastEventTimestamp,1),o=this.currentPointerPositionX-this.lastPointerPositionX,i=this.currentPointerPositionY-this.lastPointerPositionY;this.lastPointerPositionX=this.currentPointerPositionX,this.lastPointerPositionY=this.currentPointerPositionY;var a=Math.ceil(Math.sqrt(o*o+i*i)),s=a/t,n=(s-this.lastPointerSpeed)/t;if(this.lastPointerSpeed=s,s=Math.ceil(s),n=Math.ceil(n),a||s||n)this.addEvents("m",[a,s,n])}this.mouseTrackLastEventTimestamp=e,this.trackMouseIntervalObj=window.setTimeout(this.trackMouse,this.trackMouseInterval)}onMouseMove(e){this.currentPointerPositionX=e.clientX,this.currentPointerPositionY=e.clientY,this.mouseCaptured=!0}onClick(e){this.addEvents("c",[e.button,e.clientX,e.clientY])}onKeyDown(e){var t=e.key;if(v[t])t=v[t];if(p[t])this.addEvents("k",[p[t]])}addCompose(e){this.composes[e]={events:[],lastEventTimestamp:Date.now()}}removeCompose(e){if(delete this.composes[e],delete this.active[e],!this.hasComposes())this.stopTracking()}startComposeTrack(e){if(!this.composes[e])this.addCompose(e);this.active[e]=!0,this.startTracking()}pauseComposeTrack(e){if(!this.composes[e])this.addCompose(e);if(this.active[e]=!1,!this.hasComposes())this.stopTracking()}startTracking(){if(!this.started)document.body.addEventListener("keydown",this.onKeyDown,g),document.body.addEventListener("click",this.onClick,g),document.body.addEventListener("mousemove",this.onMouseMove,g),this.trackMouse(),this.started=!0}stopTracking(){if(this.trackMouseIntervalObj)window.clearInterval(this.trackMouseIntervalObj);document.body.removeEventListener("keydown",this.onKeyDown,g),document.body.removeEventListener("click",this.onClick,g),document.body.removeEventListener("mousemove",this.onMouseMove,g),this.reset()}},y=o(96596),b=o.n(y),T=o(4872),C=o.n(T),w=o(39783),E=o.n(w),k=o(92042),P=o.n(k),A=o(15907),S=o(66423),D=o.n(S),x=o(2335),O=o(39939),L=o(98448),M=o(44824),N=o(78267),Z=o(50375),R=o(63062),U=o(61799),F=o(93286),I=o(77917),H=o(84709),j=o(81061),q=o(11594),z=o(72387),B=o(73649),Y=o(37030),K=function(){return(K=Object.assign||function(e){for(var t,o=1,i=arguments.length;o<i;o++)for(var a in t=arguments[o])if(Object.prototype.hasOwnProperty.call(t,a))e[a]=t[a];return e}).apply(this,arguments)},X=b().getScope("compose.mail.ru"),V=function(){x.default.wakeUp.apply(x.default,x.SLOTS_EXCEPT_SENT),x.default.updateOnAction()},W=f.Block.extend((0,U.Z)({explicit:"radar"})({name:"compose-windows",blocks:{dimmer:q.Z,"compose-app":H.default,"compose-collapsed":j.Z,"notify-stack":B.Z,"layer-sent-page":z.default},events:{"collapsed-item-close":"onCollapsedItemClose","window-close":"onClose","window-collapse":"onCollapse","window-expand":"onExpand","letter-send":"onLetterSend","letter-schedule":"onLetterSchedule","letter-save":"onLetterSave","letter-autosave":"onLetterAutosave","letter-savetemplate":"onLetterSaveTemplate","letter-exceedmaxsize":"onExceedSize","create-note-from-letter":"onCreateNoteFromLetter"},defaults:{adaptive:!1,fullscreen:!1,compact:!1,overlap:!1,ponymode:!1,mobile:u.TOUCH_MODE,"mobile-layout":!1,"expand-status":!1,"has-right-column":!1,"right-column-compact":!1,rise:!1,"support-extend":!0,extended:!1,"close-on-error":!1,autosend:!1,"show-mobile-footer":u.CAN_SHOW_FOOTER_APP_TOOLBAR},template:m,isolateEvents:!1,constructor:function(){f.Block.prototype.constructor.apply(this,arguments),this.onLayoutUpdate=this.onLayoutUpdate.bind(this),this.onDataSourceChange=this.onDataSourceChange.bind(this)},didMount:function(){this._sending={},this._sendingCaptchaCallbacks={},R.default.setup(this.ids["compose-notify"],"compose-notify"),d.default.on("change",this.onDataSourceChange),this.onLayoutUpdate()},didUnmount:function(){d.default.off("change",this.onDataSourceChange)},animate:function(e,t,o){var i=this;if(u.COMPOSE_WINDOW_ANIMATION){var a="animate-".concat(e);setTimeout((function(){if(i.set(a,!1),o)o()}),t),this.set(a,!0)}else if(o)o()},onCollapsedItemClose:function(e){var t=e.details;this.remove(t.uid),t.destroy(),this.broadcast("window-collapsed-hide")},onClose:function(e){var t=this,o=e.details,i=o.get("form"),a=o.get("compose-options"),s=this.get("active"),n=function(){V(),i.uid===s&&t.set("active",null),t.remove(i.uid),i.destroy(),t.broadcast("window-hide")};if(!o.noAnimate)this.animate("close",100,n);else n();if(null==a?void 0:a.templateName)(0,F.ZP)({type:"compose-templates_close",dwh:{template:a.templateName}});return!1},onCollapse:function(e){var t=this,o=e.details,i=o&&o.get("form"),a=this.ids["compose-"+this.get("active")],s=o||a;if(s)s._updateComposeFields(),this.saveDraft(s,{silent:!0});var n=function(){t.hide(i.uid),t.set("expand-status",!1),V(),t.broadcast("window-hide")};if(!o.noAnimate)this.animate("collapse",350,n);else n()},onExpand:function(e){var t=this,o=e.details,i=o.get("form")||o;this.show(i.uid),this.animate("expand",350,(function(){t.set("expand-status",!0)}))},onLetterAutosave:function(e){var t=e.details;(0,F.ZP)("compose_action_save_auto"),X.add("autosave",{id:t.attrs.form.uid}),this.saveDraft(t)},onLetterSave:function(e){var t=e.details;(0,F.ZP)("compose_action_save");var o=t.get("compose-options");if(this.saveDraft(t,{userAction:!0}),null==o?void 0:o.templateName)(0,F.ZP)({type:"compose-templates_save",dwh:{template:o.templateName}})},onLetterSaveTemplate:function(e){var t=e.details,o=t.composeApp,i=t.resolve;(0,F.ZP)("compose_action_save_template"),this.saveTemplate(o).then(i,i)},onLetterSchedule:function(e){var t=e.details,o=t.composeApp,i=t.scheduleText,a=o.get("compose-options");if(this.letterSend({composeApp:o,scheduleText:i,schedule:!0}),null==a?void 0:a.templateName)(0,F.ZP)({type:"compose-templates_schedule",dwh:{template:a.templateName}})},onExceedSize:function(){this.showExceedNotify()},onLetterSend:function(e){var t,o=e.details;if(this.get("active")==(null===(t=o.get("form"))||void 0===t?void 0:t.uid)){var i=o.get("compose-options");if(this.letterSend({composeApp:o}),null==i?void 0:i.templateName)(0,F.ZP)({type:"compose-templates_send",dwh:{template:i.templateName}})}},onDataSourceChange:function(e){var t=e.details;if(t){var o=t.changes;if(o){if(o.some((function(e){var t=e.action;if(!t)return!1;else return t.type===l.UPDATE_LAYOUT_SUPPORT_3_PANE})))this.onLayoutUpdate()}}},onLayoutUpdate:function(){var e,t=this.get("layout");if(t){var o="default"in t&&"isLessThen"in t.default&&"isMoreThen"in t.default?t.default:t,i=o.columnRight,a=i>=40,s=(null==o?void 0:o.isMoreThen("xs"))&&(null==o?void 0:o.isLessThen("l"))&&i<=40,n=!(0===(null===(e=c.Z.headline)||void 0===e?void 0:e.headlinePromoHeight)||!document.querySelector(".vk-slides-iframe_show"));this.set({fullscreen:(null==o?void 0:o.isLessThen("s"))||u.TOUCH_MODE,adaptive:!n&&(null==o?void 0:o.isVertical("l")),mobile:(null==o?void 0:o.isLessThen("s"))||u.TOUCH_MODE,"mobile-xxs":null==o?void 0:o.isLessThen("xs"),overlap:(null==o?void 0:o.isLessThen("m"))||u.TOUCH_MODE,compact:s,rise:(null==o?void 0:o.isLessThen("xl"))||u.TOUCH_MODE,"3pane":"3pane"===(null==o?void 0:o.getType()),"has-right-column":a,"right-column-compact":a&&i<=40,"support-extend":(null==o?void 0:o.supportComposeExtend)&&!u.TOUCH_MODE})}},letterSend:function(e){var t=this,o=e.composeApp,i=e.schedule,a=e.scheduleText,s=o.get("form");M.default.checkOnRettachToReply(s).then((function(e){return!e.hasNewAttach?M.default.checkOnMissingAttach(s).then((function(t){return K(K({},e),{missingAttach:t})})):K(K({},e),{missingAttach:!1})})).then((function(e){var n=e.hasNewAttach,r=e.source,c=e.missingAttach;if(n)(0,F.ZP)("reattach-to-reply_reattach-open"),o.set("focusoff",!0),N.default.open("reattach-to-reply",{mobile:A.default.isLessThen("xs")},{dimmer:!0,compact:!0,resolvable:!0,mobile:A.default.isLessThen("xs")}).then((function(e){if("skip"===e)return M.default.checkOnMissingAttach(s).then((function(t){return{type:e,missingAttach:t}}));else return{type:e,missingAttach:!1}})).then((function(e){var n=e.type,c=e.missingAttach;if(o.set("focusoff",!1),"attach"===n)(0,F.ZP)("reattach-to-reply_reattach-attach"),s.reattach({sync_space_left:!0,sync_attachments:!0,reset_attachments:!1,source_model:r,force:!0}).then((function(){t.send(o,i,a)}),(function(){(0,F.ZP)("reattach-to-reply_reattach-fail")}));else if("skip"===n)if((0,F.ZP)("reattach-to-reply_reattach-skip"),c)t.checkLostAttaches(o,i,a);else t.send(o,i,a);else(0,F.ZP)("reattach-to-reply_reattach-close"),o.set("sending",!1)}),(function(){(0,F.ZP)("reattach-to-reply_open-fail"),o.set("focusoff",!1),t.send(o,i,a)}));else if(c)t.checkLostAttaches(o,i,a);else t.send(o,i,a)}))},checkLostAttaches:function(e,t,o){var i=this;(0,F.ZP)("missing_attach_open"),e.set("focusoff",!0),N.default.open("missing-attach",{mobile:A.default.isLessThen("xs")},{dimmer:!0,compact:!0,resolvable:!0,mobile:A.default.isLessThen("xs")}).then((function(a){if(e.set("focusoff",!1),"skip"===a)(0,F.ZP)("missing_attach_skip"),i.send(e,t,o);else(0,F.ZP)("missing_attach_back"),e.set("sending",!1)}),(function(){e.set("focusoff",!1),(0,F.ZP)("missing_attach_open-fail"),i.send(e,t,o)}))},getBodyCount:function(e){var t;try{var o=document.createElement("div");o.innerHTML=e;for(var i=o.querySelectorAll((0,I.selector)("blockquote")),a=i.length,s=0;s<a;s++)if(i[s].parentNode)i[s].parentNode.removeChild(i[s]);t=o.innerHTML.length}catch(e){this.radar(["body-count","error"])}return t},_getCountPostfix:function(e){return function(e){switch(!0){case e<100:return"0";case e<500:return"100";case e<1e3:return"500";case e<1e4:return Math.floor(e/1e3)+"k";case e<15e3:return"10k";case e<2e4:return"15k";case e<25e3:return"20k";case e<3e4:return"25k";case e<1e5:return"30k";case e<5e5:return"100k";case e<1e6:return"500k";case e<5e6:return"1m";case e<1e7:return"5m";default:return"".concat(Math.floor(e/1e6),"m")}}(e)},send:function(e,t,o){if(void 0===t)t=!1;if(void 0===o)o="";this._send(e,t,o)},_send:function(e,t,o){var i=this;if(void 0===t)t=!1;if(void 0===o)o="";if(e.isMounted()){var a=e.get("form"),n=a.get("subject");if(u.COMPOSE_SUBJECT_AUTOCOMPLETE&&n)!function(e,t){var o=document.createElement("iframe");o.setAttribute("name","autocomplete_iframe"),o.style.display="none",document.body.appendChild(o);var i=document.createElement("form");i.setAttribute("target","autocomplete_iframe"),i.setAttribute("action","about:blank"),i.style.position="absolute",i.style.top="-9999px",i.setAttribute("tabindex","-1"),document.body.appendChild(i);var a=document.createElement("input");if(a.setAttribute("name",e),a.setAttribute("value",t),a.setAttribute("type","text"),i.appendChild(a),i.requestSubmit&&"function"==typeof i.requestSubmit)i.requestSubmit();else i.submit();var s=()=>{i.remove(),o.removeEventListener("load",s),o.remove()};o.addEventListener("load",s)}("Subject",n);if(u.COMPOSE_SEND_USER_TRACK)this._updateComposeUserTrackFields(a);if(a.set({"compose_stat.build":u.BUILD,"compose_stat.serverTime":u.SERVER_TIME},{silent:!0}),s.default.has("body-size-radars"))setTimeout((function(){var e=i.getBodyCount(a.get("body.html"));if(void 0!==e)i.radar(["send","body-count",i._getCountPostfix(e)],e),i.radar(["send","body-count"],e);else i.radar(["send","no-body-count"])}),0);e.set("sending",!0),L.default.retryUntilCaptchaSuccess((function(e){var o=e.capcha,i={delay_for_cancellation:u.DELAY_FOR_CANCELLATION};if(o)i.capcha=o;return a.set(i),a.send(t)})).then((function(){var s=a.attachments.reduce((function(e,t){return e+(t.isCloudStock()?1:0)}),0);if(s)i.radar(["send","has-cloud-stock"],s);if(u.OVERSIZE_CLOUD_ATTACHES){var n=a.attachments.reduce((function(e,t){if(!t.isOverMaxLinkSize())return e;var o=t.get("size"),i=e.total,a=e.max,s=e.count,n=e.extensions;return n.push(t.get("content_type")),{max:Math.max(o,a),total:i+o,count:s+1,extensions:n}}),{total:0,max:0,count:0,extensions:[]}),r=n.total,c=n.max,l=n.count,d=n.extensions;if(l)(0,F.ZP)({type:"compose_oversize-cloud_send",dwh:{count:l,total:r,max:c,extensions:d.join()}})}(0,F.ZP)("compose_send");var f=a.id,m=a.cid,h=a.uid;if(X.add("send",{id:f,cid:m,uid:h,schedule:t}),i._sendEmailTypeRadar(a.get("correspondents.from.0.email")),i._sendTranslationTypeRadar(a.meta("lastSavedTranslation")),e.set("sending",!1),i._openSentPage(e,{isLateSent:t,lateSentText:o}),t)i.onLateSent(a);else i.onSent(a)}),(function(t){(0,F.ZP)("compose_send_fail"),e.set({sending:!1,errors:t.body,capcha:null}),i.onFailSent(a,t,e)})).catch((function(){e.set("sending",!1)}))}},unsubscribeCaptchaCallback:function(e){if(this._sendingCaptchaCallbacks[e])L.default.off("open-captcha-popup",this._sendingCaptchaCallbacks[e]),delete this._sendingCaptchaCallbacks[e]},isCancelDeliveryTurnOn:function(e){if(!e)return!1;var t=e.get("cancellation_token"),o=e.get("cancellation_button_lifetime");return t&&o},_openSentPage:function(e,t){var o=this,i=this.get("router"),s=e.get("form"),n=this.isCancelDeliveryTurnOn(s),r=(!a().placement("sent")||u.OCTAVIUS_MOBILE)&&u.SENT_PAGE_NOTIFY,c=s.uid,l=t.isLateSent,d=t.lateSentText;this._sending[c]=!0,this.hide(c),this.layerPromise=N.default.open("sent-page",{model:s,loading:!1,link:i.getUrl("#letters",{folder:C().SENT}),router:i,"is-delivery-cancel-version":n,"is-notify-version":r,"cancel-lifetime":s.get("cancellation_button_lifetime"),isLateSent:l,lateSentText:d},{dimmer:!r,silent:r,"close-on-esc":!r,resolvable:!1}),this.layerPromise.then((function(e){e.on("resent",o.onSent.bind(o)),e.on("layer:close",(function(e){var t=e.details;if("compose-back"!==(null==t?void 0:t.type))o.close(s.uid);V(),o.broadcast("window-hide")}))}))},saveDraft:function(e,t){var o=this,i=void 0===t?{}:t,a=i.silent,s=void 0===a?!1:a,n=i.userAction,r=void 0===n?!1:n,c=e.get("form");if(e.is("closing"))return c.save().then((function(){return(0,F.ZP)("compose_save"),d.default.updateAll()})).then((function(){o.showDraftNotify(!1,"default")})).catch((function(e){o.onFailDraft(e,!1)}));else return e.set("saving",!0),c.save().then((function(){(0,F.ZP)("compose_save");var t=c.id,i=c.cid,a=c.uid;if(X.add("save",{id:t,cid:i,uid:a}),e.set({saving:!1,"has-changes":!1}),e.setAutosaveInterval(!1),o.reloadFormData(c),!s)o.showDraftNotify()})).then((function(){return d.default.updateAll()})).catch((function(t){var i=r;o.onFailDraft(t,!1);var a=c.id,s=c.cid,n=c.uid;X.add("save failed",{id:a,cid:s,uid:n,error:t}),e.set(K(K({},i&&{errors:t.body}),{saving:!1,"has-changes":!0}))}))},onFailDraft:function(e,t,o){if(void 0===o)o=!0;(0,F.ZP)("compose_save_".concat(t?"template_":"","fail"));try{var i=e.body;if(i&&Object.keys(i).some((function(e){return/^attaches.list\[.*].id$/.test(e)&&"not_exists"===i[e].error})))(0,F.ZP)("compose_save_".concat(t?"template_":"","fail_badattach"))}catch(e){console.error(e),(0,F.ZP)("compose_save_".concat(t?"template_":"","fail_unknown"))}if(o)this.showDraftFailNotify(t)},showDraftFailNotify:function(e,t){if(void 0===t)t="compose-notify";var o=i18n("Не удалось сохранить в Черновики");if(e)o=i18n("Не удалось сохранить в Шаблоны");R.default.add({type:R.default.types.error,text:o,qa:"message-save-fail"},t)},saveTemplate:function(e){var t=this,o=e.get("form");return o.save({template:!0}).then((function(){return(0,F.ZP)("compose_save_template"),d.default.updateAll().then((function(){e.set({"template-enabled":!1}),t.showDraftNotify(!0),t.reloadFormData(o,!0)}))})).catch((function(o){e.set({errors:o.body}),t.onFailDraft(o,!0,!1),(0,F.ZP)("compose_save_template_fail")}))},showDraftNotify:function(e,t){var o=this;if(void 0===e)e=!1;if(void 0===t)t="compose-notify";var i=new Date,a=this.get("router"),s=R.default.add({text:e?i18n("Сохранено в шаблонах в {now}",{now:(0,Y.p6)(i,[["hour","2-digit"],["minute","2-digit"]])}):i18n("Сохранено в черновиках в {now}",{now:(0,Y.p6)(i,[["hour","2-digit"],["minute","2-digit"]])}),actions:[{text:i18n("Посмотреть"),event:e?"openTemplate":"openDraft"}]},t);null==s||s.on("action",(function(e){var t=e.details;if("openDraft"===t){if(o.get("active"))o.hide();a.go("#letters",{folder:C().DRAFTS})}else if("openTemplate"===t){if(o.get("active"))o.hide();a.go("#letters",{folder:C().TEMPLATES})}}))},showExceedNotify:function(e){if(void 0===e)e="compose-notify";var t={text:i18n("Картинка прикреплена как вложение"),qa:"image-attached-as-file"};R.default.add(t,e)},removeDraft:function(e){this.get("router").model.letters.filter((function(t){var o=t.getFolder();return o.isDrafts()&&!o.isTemplates()&&t.get("last")===e})).forEach((function(e){E().all.remove(e)}))},onLateSent:function(e){this.close(e.uid);var t=e.get("source.draft");if(this.layerPromise.then((function(t){t.set({loading:!1,"sent-id":e.id})})).catch((function(e){R.default.add({text:i18n("Письмо будет отправлено")}),console.error(e)})),t)this.removeDraft(t);this.reloadFormData(e,!1,!0)},onSent:function(e){var t,o=this,i=e.get("source.reply")||e.get("source.forward"),a=e.get("source.draft"),s=P().getListByMessageId(i),n=this.get("router");this.close(e.uid);var r=P().findOne(e.id);if(this.set("autosend",!1),null===(t=this.layerPromise)||void 0===t||t.then((function(t){var o=n.getUrl("#read-letter",{folder:C().SENT,letter:e.id});t.set({link:o,loading:!1,"sent-id":e.id}),(0,F.ZP)("compose_sent-page")})).catch((function(e){R.default.add({text:i18n("Письмо отправлено")}),(0,F.ZP)("compose_sent-page"),(0,F.ZP)("compose_sent-page_layer-error"),console.error(e)})),r.then((function(){if(s.forEach((function(t){if(t.get("last")===i)e.get("source.reply")&&t.set("flags.reply",!0,{silent:!0}),e.get("source.forward")&&t.set("flags.forward",!0,{silent:!0});t.expire()&&t.fetch()})),a)o.removeDraft(a);o.reloadFormData(e,!1,!0)})).catch((function(e){(0,F.ZP)("compose_sent-page_thread-error"),console.error(e)})),e.get("calls"))this.radar(["send","calls"])},onFailSent:function(e,t,o){var i=t.body,a=t.status;if(delete this._sending[e.uid],this.unsubscribeCaptchaCallback(e.uid),"invalid"!==D().codes[a]||"too_long"!==i){if(this.showSendFailNotify(),this.get("close-on-error"))this.onClose({details:o})}else R.default.add({type:R.default.types.error,text:i18n("Превышен лимит на размер письма")},"compose-notify")},showSendFailNotify:function(e){if(void 0===e)e="compose-notify";R.default.add({type:R.default.types.error,text:i18n("Не удалось отправить письмо"),qa:"message-send-fail"},e)},reloadFormData:function(e,t,o){if(!t)this.updateAffectedMessage(e,o);Z.default.invalidateCache(),Z.default.emit("any:reload")},updateAffectedMessage:function(e,t){var o=["reply","forward"].find((function(t){return e.is("source.".concat(t))}));if(o){var i=E().all.get(e.get("source.".concat(o)));if(i)if(t)i.set("drafts.".concat(o),"");else{var a=[];if(["to","cc"].forEach((function(t){e.get("correspondents.".concat(t)).forEach((function(e){if(~e.email.indexOf("@")&&!a.includes(e.email))a.push(e.email)}))})),"reply"===o&&a.length>1)o="replyall";var s={"drafts.last_type":o};s["drafts.".concat(o)]=e.get("source.draft"),i.set(s)}}},getCollapsed:function(e){var t=this,o=this.get("active");return e.filter((function(e){var i=e.formData;return i.uid!==o&&!t._sending[i.uid]}))},add:function(e,t){var o=this.get("items").find((function(t){var o=t.formData;if(o.uid===e.uid)return!0;else{var i=o.get("source"),a=e.get("source");if(i.draft&&!Object.keys(i).some((function(e){return i[e]!==a[e]})))return!0}return!1}));if(o)return this.animate("expand",350),void this.show(o.formData.uid);this.animate("open",100),this.get("items").push({formData:e,autosend:t&&t.autosend,isDragAndDrop:t&&t.isDragAndDrop,dragAndDropItem:t&&t.dragAndDropItem,additionalOptions:t}),this.show(e.uid),this.render()},show:function(e){if(this.set("active",e),u.COMPOSE_SEND_USER_TRACK)_.startComposeTrack(e);x.default.sleep.apply(x.default,x.SLOTS_EXCEPT_SENT),this.broadcast("window-show")},hide:function(e){var t=this.get("active");if(!e&&null!==t)e=this.get("items").find((function(e){return e.formData.uid==t})).formData.uid;if(e===t)this.set("active",null);if(u.COMPOSE_SEND_USER_TRACK)_.pauseComposeTrack(e)},close:function(e){e===this.get("active")&&this.set("active",null),this.remove(e)},remove:function(e){delete this._sending[e],this.unsubscribeCaptchaCallback(e);var t=this.get("items").filter((function(t){return t.formData.uid!==e}));if(this.set({items:t}),u.COMPOSE_SEND_USER_TRACK)_.removeCompose(e)},_updateComposeUserTrackFields:function(e){var t=_.serialize(e.uid);e.set("compose_stat.user_track",t,{silent:!0}),r().send("compose-user-track",{i:{size:t.length}})},_getCollectors:function(){return this.get("router").model.collectors},_getAliases:function(){return this.get("router").model.aliases},_sendEmailTypeRadar:function(e){var t="unknown-email";if(e===O.default.user.getEmail())t="main-email";if(this._getCollectors().some((function(t){return t.getEmail()===e})))t="collector";if(this._getAliases().some((function(t){return t.getEmail()===e})))t="alias";(0,F.ZP)(["send","email",t])},_sendTranslationTypeRadar:function(e){if(e)(0,F.ZP)({type:"send_translated_languages",intervals:[["from",e.fromlang],["to",e.tolang]]}),(0,F.ZP)("send_translated")},insertHtml:function(e){var t=this.ids["compose-"+this.get("active")];if(t)t.insertHtml(e)},useNewToolbar:function(){return u.NEW_TOOLBAR},onCreateNoteFromLetter:function(e){var t=this,o=e.details;this.saveDraft(o,{userAction:!0,silent:!0}).then((function(){var e=o.get("form").get("source.draft");t.openNote(e)}))},openNote:function(e){(0,h.default)("".concat(u.NOTES_URL,"/create-note-from-letter/?letter-id=").concat(e,"&source=suggest_input"))}}))}}]);