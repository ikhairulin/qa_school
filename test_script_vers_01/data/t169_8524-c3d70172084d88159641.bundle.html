(self.webpackChunk_mail_octavius=self.webpackChunk_mail_octavius||[]).push([[8524],{38495:function(e,t,n){var r,a;r=[n(43572),n(83260)],void 0===(a=function(e,t){"use strict";var n=function(){},r=window.performance,a=function(e,t){var n="task_"+t+"_"+e;r.mark(n+"_end");try{r.measure(n,n+"_start",n+"_end")}catch(e){console.warn("Failed to measure "+n,e)}},i=e.extend({constructor:function(n){e.apply(this),this.context=t.cloneObject(n),Object.freeze&&Object.freeze(this.context),this._promise=new Promise(function(e,t){this.resolve=e,this.reject=t}.bind(this)),this._promise=this._promise.then(function(e){return this.set("status",i.STATUS_RESOLVED),this.emit(i.EVENT_RESOLVE,[this,e]),this.emit(i.EVENT_END,[this,e]),a(this.cid,this.type+"@"+this.className),this.emit(i.EVENT_INTERNAL_SCHEDULER_NEXT,[this,e]),e}.bind(this)),this._promise=this._promise.catch(function(e){throw this.set("status",i.STATUS_REJECTED),this.emit(i.EVENT_REJECT,[this,e]),this.emit(i.EVENT_END,[this,e]),a(this.cid,this.type+"@"+this.className),this.emit(i.EVENT_INTERNAL_SCHEDULER_NEXT,[this,e]),e}.bind(this))},className:"Task",type:"generic",context:{},defaults:{status:"awaiting",cancelled:!1},_promise:null,resolve:null,reject:null,didStart:n,willCancel:n,start:function(){var e,t;e=this.cid,t=this.type+"@"+this.className,r.mark("task_"+t+"_"+e+"_start"),this.set("status",i.STATUS_RUNNING),this.emit(i.EVENT_START,[this]);try{this.didStart()}catch(e){this.reject(e)}},cancel:function(e){this.set({status:i.STATUS_REJECTED,cancelled:!0}),this.emit(i.EVENT_CANCEL,[this,e]);try{this.willCancel(e)}catch(e){return void this.reject(e)}this.reject(e)},asPromise:function(){return this._promise},then:function(){return this._promise=this._promise.then.apply(this._promise,arguments),this._promise},catch:function(){return this._promise=this._promise.catch.apply(this._promise,arguments),this._promise},isCancelled:function(){return this.is("cancelled")}});return t.extend(i,{fromCallback:function(e,t,n){return new(i.extend({type:t,didStart:function(){var t=e();if(!t||!t.then)this.resolve(t);else t.then(this.resolve,this.reject)}}))(n)},EVENT_PROGRESS:"progress",EVENT_START:"start",EVENT_END:"end",EVENT_RESOLVE:"resolve",EVENT_REJECT:"reject",EVENT_INTERNAL_SCHEDULER_NEXT:"internal_scheduler_next",EVENT_CANCEL:"cancel",STATUS_AWAITING:"awaiting",STATUS_RUNNING:"running",STATUS_REJECTED:"rejected",STATUS_RESOLVED:"resolved"}),i.version="0.2.0",i}.apply(t,r))||(e.exports=a)},33368:function(e,t,n){var r,a;r=[n(43572),n(38495),n(96596),n(83260)],void 0===(a=function(e,t,n,r){"use strict";var a=e.extend({className:"TaskScheduler",_queuesConfig:null,_queues:null,_running:null,constructor:function(t){if(e.apply(this),this._queuesConfig={},this._queues={},this._running={},this._onTaskInternalNext=this._onTaskInternalNext.bind(this),this._removeTask=this._removeTask.bind(this),"object"==typeof t)this._configureQueues(t)},start:function(e,t){switch(("object"==typeof t?t:{}).execution||"queued"){case"immediate":this._scheduleImmediate(e);break;case"queued":this._scheduleQueued(e)}},cancel:function(e,t){if(!Array.isArray(e))this._cancel(e,t,!1);else this._cancelTaskArray(e,t)},findFirst:function(e,t){var n;if(void 0!==t){if(!(n=this._arrayFindFirstTask(e,this._running[t])))n=this._arrayFindFirstTask(e,this._queues[t]);return n}if(n=this._mapFindFirstTask(e,this._running))return n;else return n=this._mapFindFirstTask(e,this._queues)},cancelAll:function(e){var t;[this._queues,this._running].forEach(function(n){for(t in n)if(n.hasOwnProperty(t))this._cancelTaskArray(n[t],e),n[t].length=0}.bind(this))},cancelOfType:function(e,t){this._cancelTaskArray(this._queues[e],t),this._cancelTaskArray(this._running[e],t)},isRunning:function(e){return this._arrayHasTask(this._running[e.type],e)},isQueued:function(e){return this._arrayHasTask(this._queues[e.type],e)},hasRunningTasks:function(){return this._arrayMapHasTasks(this._running)},hasQueuedTasks:function(){return this._arrayMapHasTasks(this._queues)},hasRunningTasksOfType:function(e){var t=this._running[e];return!(!t||!t.length)},hasQueuedTasksOfType:function(e){var t=this._queues[e];return!(!t||!t.length)},map:function(e){var n,r=this._queues,a=this._running,i=[],s=function(e){return e.get("status")!==t.STATUS_RESOLVED}.bind(this);return[r,a].forEach((function(t){for(n in t)if(t.hasOwnProperty(n))i=[].concat(t[n].filter(s).map(e),i)})),i},waitForAll:function(){return new Promise(function(e,n){Promise.all(this.map((function(e){return new Promise((function(n){e.on(t.EVENT_INTERNAL_SCHEDULER_NEXT,(function(r,a){n({result:a,status_error:e.get("status")!==t.STATUS_RESOLVED&&e.get("status")!==t.EVENT_CANCEL})}))}))}))).then((function(t){if(t.some((function(e){return e.status_error})))return n(t);e(t)}))}.bind(this))},_configureQueues:function(e){var t;for(var n in e)if(e.hasOwnProperty(n))t=e[n],this._queuesConfig[n]={maxConcurrent:t.maxConcurrent||1},this._queues[n]=[],this._running[n]=[]},_scheduleImmediate:function(e){var t=this._running[e.type];if(!t)t=this._running[e.type]=[];t.push(e),this._scheduleNextAfter(e),e.start()},_scheduleQueued:function(e){var t=this._queuesConfig[e.type],n=this._queues[e.type],r=this._running[e.type];if(t&&n&&r&&!(r.length<t.maxConcurrent))n.unshift(e);else this._scheduleImmediate(e)},_scheduleNextAfter:function(e){e.on(t.EVENT_INTERNAL_SCHEDULER_NEXT,this._onTaskInternalNext)},_onTaskInternalNext:function(e,t){var n=this._queuesConfig[e.type],r=this._queues[e.type],a=this._running[e.type];if(this._removeTask(e,t),n&&a.length<n.maxConcurrent){var i=r.pop();i&&this._scheduleImmediate(i)}},_removeTask:function(e,t){var n,r=this._running[e.type],a=this._queues[e.type];(n=r&&r.indexOf(e))>=0&&r.splice(n,1),(n=a&&a.indexOf(e))>=0&&a.splice(n,1)},_cancelTaskArray:function(e,t){var n,r;if(e&&e.length)for(var a=0;a<e.length;a++)n=e[a],r=a+1===e.length,this._cancel(n,t,!r)},_arrayHasTask:function(e,t){if(!e)return!1;else return e.indexOf(t)>=0},_arrayMapHasTasks:function(e){for(var t in e)if(e.hasOwnProperty(t))if(e[t].length)return!0;return!1},_arrayFindFirstTask:function(e,t){for(var n,r=0;r<t.length;r++)if(e(n=t[r]))return n},_mapFindFirstTask:function(e,t){var n;for(var r in t)if(t.hasOwnProperty(r))if(n=this.findFirst(e,r))return n},_cancel:function(e,n,r){if(r)e.off(t.EVENT_INTERNAL_SCHEDULER_NEXT,this._onTaskInternalNext),e.on(t.EVENT_INTERNAL_SCHEDULER_NEXT,this._removeTask);e.cancel(n),e.catch((function(){})),this._removeTask(e)}});return a.version="0.2.1",r.extend(a,{EXECUTION_IMMEDIATE:"immediate",EXECUTION_QUEUED:"queued",EXECUTION_DEFAULT:"queued",MAX_CONCURRENT_DEFAULT:1}),a}.apply(t,r))||(e.exports=a)},16367:function(e,t,n){var r,a,i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])if(Object.prototype.hasOwnProperty.call(t,a))e[a]=t[a];return e}).apply(this,arguments)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(81465),n(20848),n(3911),n(38495),n(83260),n(50),n(33368),n(63150)],void 0===(a=function(e,t,n,r,a,o,c,u,l,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onAttachmentsChange=t.addAttachment=void 0,n=s(n),r=s(r),a=s(a),o=s(o),c=s(c),u=s(u),l=s(l);var f=function(e,t){var s=t.attachment,c=t.isLink;if(t.isOversizeAttach)return new n.default(t);if(c)return new r.default(t);if(s.isFromCloud())return function(e,t){var n=e.transport,r=e.uid,a=n.getRPC(),s=t.skipFromQueue,c=t.attachment;return o.default.fromCallback((function(){return Promise.resolve({email:a.setup("email"),folder_id:c.get("folder_id"),token:a.setup("token"),message_id:r,cloud_id:null}).then((function(e){return c.destroyed?Promise.reject(new Error("Attachment destroyed")):i(i({},e),{cloud_id:c.get("cloud_id")})})).then((function(e){return a.post(n.getUrl("addCloudAttachment"),e,{force:s})}))}),"upload_attachment",t)}(e,t);if(s.isFromAttachSearch())return function(e,t){var n=e.transport,r=e.uid,a=n.getRPC(),s=t.skipFromQueue,c=t.attachment;return o.default.fromCallback((function(){return Promise.resolve({email:a.setup("email"),folder_id:c.get("folder_id"),token:a.setup("token"),message_id:r,id:c.getFileSearchAttachId()}).then((function(e){return c.destroyed?Promise.reject(new Error("Attachment destroyed")):i(i({},e),{id:c.getFileSearchAttachId()})})).then((function(e){return a.post(n.getUrl("addForwardAttachment"),e,{force:s})})).catch((function(e){if(h(e))return e;else return Promise.reject(e)}))}),"upload_attachment",t)}(e,t);else return new a.default(t)},h=function(e){var t="filesize_limit_exceeded"===String(e.get("body.id.error")),n=Object.keys(e.get("body")).some((function(e){return e.startsWith("mbox_quotas")}));return t||n},p=function(e,t){var n=t.context,r=n.attachment,a=n.callbacks;t.on(o.default.EVENT_REJECT,(function(t,n){return function(e,t,n){var r=t.context,a=r.attachment,i=r.logScope,s=r.size,o=r.callbacks;if(i.add("fail",n),!t.isCancelled())(0,d.removeAttachment)(e,a);e.increment("space_left",s),o.oncomplete(n,a,null)}(e,t,n)})),t.on(o.default.EVENT_RESOLVE,(function(t,n){return function(e,t,n){var r=t.context,a=r.attachment,i=r.logScope,s=r.callbacks;if(n){if(i.add("success",n.get("body")),(0,d.syncSpaceLeft)(e,n,"_onAttachmentTaskResolve"),a.isForward()&&h(n))a.set({id:a.getFileSearchAttachId()});else if(a.set(n.get("body.attach"),{clean:!0}),!a.isInline())a.set("type",u.default.TYPE_FILE);s.oncomplete(null,a,n)}else s.oncomplete(null,a,n)}(e,t,n)})),t.on(o.default.EVENT_START,(function(){return a.onupload(r)})),t.on(o.default.EVENT_PROGRESS,(function(e,t){return a.onprogress(t,r)}))};t.addAttachment=function(e,t,n){if(void 0===n)n={};if(e.is("finalized"))return Promise.reject(new Error("Unable to add an attachment, MessageFormData is finalized"));var r=!1,a=0;if(!t.isForward())a=(r=t.isOverMaxSize()||e.get("space_left")-t.get("size")<0)?0:t.get("size");var i=(n=c.default.extend({onupload:function(){},onprogress:function(){},oncomplete:function(){}},n)).disableBigCloudAttach,s=void 0===i?!0:i,o=n.loadToCloud,u=n.loadBlobCloud,d=n.blobCloudPath;if(r&&t.isOverMaxLinkSize()&&s)return Promise.reject({body:{error:"oversize_file"}});t.on("destroy",e),e.increment("space_left",-a),e.attachments.set([t]);var h=!s&&t.isOverMaxLinkSize()&&t.isBlob(),m=e.logScope,_=e.scheduler,v=e.transport,g=e.uid,y=e.isSaving,b=m.scope("addAttachment",{cid:t.cid,size:t.get("size"),type:t.get("type"),cloud_id:t.get("cloud_id"),content_id:t.get("content_id")}),E=f(e,{transport:v,attachment:t,callbacks:n,size:a,logScope:b,messageId:g,isLink:r,skipFromQueue:!y,loadToCloud:o,isOversizeAttach:h,loadBlobCloud:u,blobCloudPath:d});p(e,E);var T=h?l.default.EXECUTION_IMMEDIATE:l.default.EXECUTION_QUEUED;return _.start(E,{execution:T}),E.asPromise().then((function(){return t}))};t.onAttachmentsChange=function(e){var t=e.get("subject");if(null!==t&&e._previousAttachmentSubject!==t)e.set("features.subject_from_attachments",!1);if(e.is("features.subject_from_attachments"))e.makeSubjectFromAttachments();e._previousAttachmentSubject=e.get("subject")}}.apply(t,r))||(e.exports=a)},63150:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(50)],void 0===(a=function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeAttachments=t.removeAttachment=t.findAttachmentTask=t.syncSpaceLeft=void 0,n=i(n);t.syncSpaceLeft=function(e,t,n){if(!e.scheduler.hasQueuedTasksOfType("upload_attachment")){var r=t.get("body.space_left"),a=e.get("space_left");e.logScope.add("space_left is synced in ".concat(n),{prev:a,next:r}),e.set("space_left",r)}};t.findAttachmentTask=function(e,t){return e.scheduler.findFirst((function(e){return e.context.attachment===t}),"upload_attachment")};t.removeAttachment=function(e,r,a){if(e.is("finalized"))return Promise.reject(new Error("Unable to remove an attachment, MessageFormData is finalized"));var i=(0,t.findAttachmentTask)(e,r),s=e.scheduler,o=e.logScope,c=e.transport;if(i)s.cancel(i,"removeAttachment");var u,l=o.scope("removeAttachment",{cid:r.cid,size:r.get("size"),type:r.get("type"),cloud_id:r.get("cloud_id"),content_id:r.get("content_id")}),d=function(){l.add("destroyed",r.id),r.off("destroy",e),r.destroy()};if(r.isNew()||r.isInline())return d(),Promise.resolve();switch(!0){case r.isCloudStock():u=c.getRPC().post(c.getUrl("removeAttachmentAsLink"),{bundle_id:r.get("bundle_id"),file_id:r.get("file_id")});break;case r.isCloud():var f="forward"===e.getMode(),h="reply"===e.getMode();if(!f&&!h&&(null==a?void 0:a.removeAttachmentFromCloud))u=a.removeAttachmentFromCloud(r.get("cloud_id"));else u=Promise.resolve();break;case!r.isCloudStock()&&!r.isCloud():u=c.getRPC().post(c.getUrl("removeAttachment"),{ids:[r.id],message_id:e.uid})}return u.then((function(a){if(a?l.add("xhr.success",a):l.add("noxhr.success"),d(),r.get("type")===n.default.TYPE_FILE&&a)(0,t.syncSpaceLeft)(e,a,"removeAttachment")})).catch((function(e){l.add("fail",e)})),u};t.removeAttachments=function(e,n,r){if(e.is("finalized"))return Promise.reject(new Error("Unable to remove attachments, MessageFormData is finalized"));var a=n.map((function(n){return(0,t.findAttachmentTask)(e,n)})).filter((function(e){return!!e}));e.scheduler.cancel(a,"removeAttachments");var i=n.map((function(n){return(0,t.removeAttachment)(e,n,r)}));return Promise.all(i).then((function(){if(!e.attachments.length)e.set("space_left",e.MAX_SPACE_LEFT)}))}}.apply(t,r))||(e.exports=a)},83327:function(e,t,n){var r,a,i=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,a=0,i=t.length;a<i;a++)if(r||!(a in t)){if(!r)r=Array.prototype.slice.call(t,0,a);r[a]=t[a]}return e.concat(r||Array.prototype.slice.call(t))};r=[n,t,n(14091)],void 0===(a=function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.constructFormData=void 0;var r=function(e){var t=e.mode,r=e.formData,a=e.model,s=e.collectors,o=e.aliases,c=e.email;if(t===n.FormDataModes.replyall||t===n.FormDataModes.reply||t===n.FormDataModes.forward)r.set("correspondents.from",[r.getFrom(a,i(i([],s,!0),o,!0),c)]);switch(t){case n.FormDataModes.reply:r.set({"correspondents.to":a.get("replies.to")});break;case n.FormDataModes.replyall:r.set({"correspondents.to":a.get("replies.all"),"correspondents.cc":a.get("replies.cc")});break;case n.FormDataModes.new:case n.FormDataModes.template:case n.FormDataModes.draft:case n.FormDataModes.schedule:r.set({correspondents:a.get("correspondents"),priority:a.get("priority"),receipt:a.get("flags.receipt"),remind:a.get("remind")})}};t.constructFormData=function(e){var t=e.formData,a=e.folder_id,i=e.mode;if(i===n.FormDataModes.smartreply)t.isSmartReply=!0,e.mode=n.FormDataModes.replyall;if("number"==typeof a||"string"==typeof a)t.set("folder_id",a);if(function(e){var t=e.formData,r=e.mode,a=e.model.id;switch(r){case n.FormDataModes.replyall:t.set("source.reply",a);break;case n.FormDataModes.template:t.set({"source.template":a,"source.draft":a});break;case n.FormDataModes.new:break;default:t.set("source.".concat(r),a)}}(e),i===n.FormDataModes.draft)!function(e){var t=e.formData,r=e.model,a=e.source;if(!a){var i=r.get("headers");if(i)if(!i[n.HEADER_REPLY_MESSAGE]){if(i[n.HEADER_FORWARD_MESSAGE])t.set("source.forward",i[n.HEADER_FORWARD_MESSAGE])}else t.set("source.reply",i[n.HEADER_REPLY_MESSAGE])}else{var s=a.mode,o=a.id,c=s===n.FormDataModes.replyall?"reply":s;t.set("source.".concat(c),o)}}(e);r.call(this,e),function(e){var t=e.mode,r=e.formData,a=e.model;if(t===n.FormDataModes.schedule&&a.isSchedule())r.set("send_date",a.get("send_date"))}(e);var s=function(e){var t=e.mode,r=e.model,a=e.body,i=e.signature,s=t===n.FormDataModes.reply||t===n.FormDataModes.replyall?"replay":t,o=r.get("templates.".concat(s)),c=r.get("subject"),u=r.get("body.html"),l=u;if(o){if(c=o.subject,"string"==typeof u)u=(0,n.encodePlaceholder)(u);var d=o.body.html,f=(0,n.bodyHtmlPreparingReplace)(d,u,i);l="".concat(a).concat(f)}return{subject:c,bodyHtml:l}}(e),o=s.subject,c=s.bodyHtml;return t.set({subject:o,"body.html":c}),t}}.apply(t,r))||(e.exports=a)},21290:function(e,t,n){var r,a,i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}c((r=r.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[2&o[0],a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(66423)],void 0===(a=function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cancelDelivery=void 0,n=o(n);t.cancelDelivery=function(e){return i(void 0,void 0,void 0,(function(){var t,r,a;return s(this,(function(i){return t=e.transport,r=t.getRPC(),a={cancellation_token:e.get("cancellation_token")},[2,r.get(t.getUrl("cancelDelivery"),a).then((function(t){var n=t.body.draft_id;return e.set({delivery_canceled:!0,draft_id:n}),{success:!0}})).catch((function(e){var t=e.get("status");if(n.default.codes[t])return{error:t};else return Promise.reject(e)}))]}))}))}}.apply(t,r))||(e.exports=a)},83821:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(43572)],void 0===(a=function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.destroy=void 0,n=i(n);t.destroy=function(e){if(e._sendPromise)return!1;else return e.scheduler.cancelAll("destroy"),e.attachments.reset(),e.clearKeepaliveInterval(),n.default.fn.destroy.call(e),!0}}.apply(t,r))||(e.exports=a)},78426:function(e,t,n){var r,a,i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}c((r=r.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[2&o[0],a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(66423)],void 0===(a=function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.forceDelivery=void 0,n=o(n);t.forceDelivery=function(e){return i(void 0,void 0,void 0,(function(){var t,r,a;return s(this,(function(i){return t=e.transport,r=t.getRPC(),a={cancellation_token:e.get("cancellation_token")},[2,r.get(t.getUrl("forceDelivery"),a).then((function(){return e.set("delivery_forced",!0),{success:!0}})).catch((function(e){var t=e.get("status");if(n.default.codes[t])return{error:t};else return Promise.reject(e)}))]}))}))}}.apply(t,r))||(e.exports=a)},29351:function(e,t,n){var r,a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[2&o[0],a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};void 0===(r=function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.save=void 0;t.save=function(e,t){return a(this,void 0,void 0,(function(){var n,r,s,o,c,u,l,d=this;return i(this,(function(f){switch(f.label){case 0:if(e.isSaving)return e.needsResave=!0,[2,Promise.resolve(null)];e.isSaving=!0,n=e.transport,t=t||{},e.trigger("before-saved"),f.label=1;case 1:return f.trys.push([1,6,,7]),[4,e.logScope.call("save",t,(function(){return a(d,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,e.restoreExpiredAttachments()];case 1:return[2,t.sent()]}}))}))}))];case 2:return f.sent(),[4,e.waitForUploads()];case 3:return f.sent(),[4,e.preprocess("save")];case 4:if(f.sent(),(r=e.toJSON()).save_as_template=!!t.template,s=r.attaches.list,o=e.getLoadedAttaches(s),s.length!==o.length)return e.isSaving=!1,[2,e.save(t)];else return[4,n.getRPC().post(n.getUrl("saveDraft"),r)];case 5:if(c=f.sent(),e.set("source.draft",c.get("body.id")),e.trigger("saved",e),e.isSaving=!1,!e.needsResave)return[2,c];else return(u=e.toJSON()).save_as_template=!!t.template,n.getRPC().post(n.getUrl("saveDraft"),u),e.needsResave=!1,[2,c];case 6:return l=f.sent(),e.isSaving=!1,[2,Promise.reject(l)];case 7:return[2]}}))}))}}.apply(t,[n,t]))||(e.exports=r)},61640:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(96596)],void 0===(a=function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sendMessage=void 0,n=i(n);t.sendMessage=function(e,t){var r=e._sendPromise,a=e.transport,i=e.uid,s=e.destroyed;if(e._sendPromise&&e._sendPromiseFailed!==e._sendPromise)return r;var o=e.logScope.scope(t?"schedule":"send",i);if(s)r=Promise.reject(new Error("MessageFormData destroyed"));else o.add("add2queue",{finalized:!0}),e.trigger(t?"before-schedule":"before-sent",e),r=o.call((function(){return e.restoreExpiredAttachments()})).then((function(){return e.clearKeepaliveInterval(),e.waitForUploads()})).then((function(){return e.preprocess("send")})).then((function(){e.set("finalized",!0),e.trigger("finalized",e);var n=e.toJSON();return e.transport.getRPC().post(a.getUrl(t?"schedule":"send"),n)})).then((function(r){return e.set(r.get("body")),e.trigger(t?"schedule":"sent",e),n.default.add("sent.id",e.id),e}));return r.catch((function(t){o.add("fail",t),e._sendPromiseFailed=e._sendPromise})),e._sendPromise=r,e._sendPromiseFailed=null,r}}.apply(t,r))||(e.exports=a)},55508:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(43572),n(14091)],void 0===(a=function(e,t,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toJSON=void 0,n=i(n);t.toJSON=function(e,t){var a=n.default.fn.toJSON.apply(e,t),i=[];if(a.id=e.uid,a.attaches={list:[]},a.attaches.list=e.attachments.filter((function(e){if(!e.isCloudStock())return!0;var t=e.get("bundle_id");if(!i.includes(t))return i.push(t),!0;else return!1})).map((function(e){if(e.isCloudStock())return{id:e.get("bundle_id"),type:e.get("type")};var t={id:e.id,type:e.get("type")},n=e.get("content_id");if(n)t.content_id=n;return t})),a.from=(0,r.toAddress)(e.get("correspondents.from.0")),a.correspondents={to:(0,r.toAddresses)(e.get("correspondents.to")),cc:(0,r.toAddresses)(e.get("correspondents.cc")),bcc:(0,r.toAddresses)(e.get("correspondents.bcc"))},-1===a.sign)delete a.sign;return["space_left","finalized","features"].forEach((function(e){return delete a[e]})),a}}.apply(t,r))||(e.exports=a)},68524:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(96596),n(43572),n(33368),n(39783),n(50),n(74285),n(66996),n(20848),n(94965),n(14091),n(96897),n(16367),n(63150),n(64810),n(32666),n(61640),n(29351),n(21290),n(78426),n(83821),n(55508),n(30599),n(20509),n(24003)],void 0===(a=function(e,t,n,r,a,s,o,c,u,l,d,f,h,p,m,_,v,g,y,b,E,T,A,S,w){"use strict";n=i(n),r=i(r),a=i(a),s=i(s),o=i(o),c=i(c),u=i(u),l=i(l),d=i(d);var x=r.default.extend({className:"mail.MessageFormData",defaults:{id:null,source:{draft:"",reply:"",forward:"",schedule:""},headers:{},template:0,sign:0,remind:0,receipt:!1,subject:"",priority:s.default.PRIORITY_NORMAL,send_date:"",body:{html:"",text:""},from:"",correspondents:{to:[],cc:[],bcc:[]},features:{subject_from_attachments:!1,max_shown_attachments:3},folder_id:null,space_left:1/0,finalized:!1},shortcuts:{cc:"correspondents.cc",to:"correspondents.to",bcc:"correspondents.bcc"},scheduler:null,transport:null,isSaving:!1,needsResave:!1,constructor:function(e,t){var i=this;if(void 0===e)e={};if(void 0===t)t={};r.default.call(this,e),this.on("destroy",this),this.scheduler=new a.default({upload_attachment:{maxConcurrent:1}}),this.uid=(0,f.createTemporaryLetterUid)(),this.logScope=n.default.scope("[[".concat(this.className,"]]"),{uid:this.uid}),this.preprocessor=new c.default,this.model=new s.default,this.attachments=new o.default.List,this.attachments.on("change remove",(function(){return i._onAttachmentsChange()})),this._previousAttachmentSubject=this.defaults.subject,this._lastKeepaliveDate=(new Date).getTime(),this.reattach=function(e){return(0,h.reattach)(i,e)},this.keepalive=function(){return(0,h.keepalive)(i)},this.setKeepaliveInterval=function(){return(0,h.setKeepaliveInterval)(i)},this.clearKeepaliveInterval=function(){return(0,h.clearKeepaliveInterval)(i)},this.restoreExpiredAttachments=function(){return(0,h.restoreExpiredAttachments)(i)},this.__restoreExpiredAttachments=function(){return(0,h.restoreExpiredAttachmentsProcess)(i)},this.isKeepaliveExpired=function(){return(0,h.isKeepaliveExpired)(i)},this._onAttachmentsChange=function(){return(0,p.onAttachmentsChange)(i)},this.addAttachment=function(e,t){return(0,p.addAttachment)(i,e,t)},this.removeAttachment=function(e){return(0,m.removeAttachment)(i,e)},this.removeAttachments=function(e){return(0,m.removeAttachments)(i,e)},this.findAttachmentTask=function(e){return(0,m.findAttachmentTask)(i,e)},this.applyTemplate=function(e){return(0,_.applyTemplate)(i,e)},this.fetchTemplate=function(e){return(0,_.fetchTemplate)(e)},this.mergeTemplate=function(e,t){return(0,_.mergeTemplate)(i,e,t)},this.translate=function(e){return(0,v.translate)(i,e)},this.translateSubject=function(e){return(0,v.translateSubject)(i,e)},this.translateBody=function(e){return(0,v.translateBody)(i,e)},this.clearTranslation=function(e){return(0,v.clearTranslation)(i,e)},this.saveTranslation=function(e){return(0,v.saveTranslation)(i,e)},this.cancelTranslationSave=function(){return(0,v.cancelTranslationSave)(i)},this.send=function(e){return(0,g.sendMessage)(i,e)},this.save=function(e){return(0,y.save)(i,e)},this.cancelDelivery=function(){return(0,b.cancelDelivery)(i)},this.forceDelivery=function(){return(0,E.forceDelivery)(i)},this.destroy=function(){return(0,T.destroy)(i)},this.preprocess=function(){return(0,S.preprocess)(i)},this.getLoadedAttaches=function(e){return(0,S.getLoadedAttaches)(e)},this.isUploadingAttachments=function(){return(0,S.isUploadingAttachments)(i)},this.waitForUploads=function(){return(0,S.waitForUploads)(i)},this.handleEvent=function(e){return(0,S.handleEvent)(i,e)},this.resetSpaceLeft=function(){return(0,S.resetSpaceLeft)(i)},this.getMode=function(){return(0,S.getMode)(i)},this.toJSON=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return(0,A.toJSON)(i,e)},this.makeSubjectFromAttachments=function(){return(0,w.makeSubjectFromAttachments)(i)},this.create=function(e){return(0,w.create)(i,e)},this.getFrom=function(e,t,n){return(0,w.getFrom)(e,t,n)};var d=t.getFwdMessage,x=void 0===d?w.getFwdMessage:d,k=t.getAttachmentsMoreText,M=void 0===k?w.getAttachmentsMoreText:k,D=e.MAX_SPACE_LEFT,C=void 0===D?26214400:D,P=e.MAX_ATTACHMENTS_COUNT,N=void 0===P?100:P,F=e.ATTACHMENTS_RESTORE,O=void 0===F?!0:F,R=e.USE_S3_INSTEAD_CLOUDSTOCK,j=void 0===R?!1:R,L=e.ATTACHMENTS_EXPIRATION_TIME,I=void 0===L?8e4:L;this.getFwdMessage=function(e,t){return x(e,t)},this.getAttachmentsMoreText=function(e){return M(e)},this.MAX_SPACE_LEFT=C,this.MAX_ATTACHMENTS_COUNT=N,this.ATTACHMENTS_RESTORE=O,this.USE_S3_INSTEAD_CLOUDSTOCK=j,this.ATTACHMENTS_EXPIRATION_TIME=I,this.isValidCloudStockResponse=l.default.isValidCloudStockResponse,this.parseCloudStockResponse=l.default.parseCloudStockResponse,this.set("space_left",this.MAX_SPACE_LEFT),this._restoreExpiredAttachments=this.ATTACHMENTS_RESTORE,this.transport=new u.default(e),this.transport.set("use-s3",this.USE_S3_INSTEAD_CLOUDSTOCK),this.transport.attachmentsKeepaliveExpirationTime=this.ATTACHMENTS_EXPIRATION_TIME,this.setKeepaliveInterval()}});return d.default.apply(x),x.version="0.9.0",t.default=x,x}.apply(t,r))||(e.exports=a)},30599:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(50),n(14091)],void 0===(a=function(e,t,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getMode=t.resetSpaceLeft=t.handleEvent=t.preprocess=t.isUploadingAttachments=t.getLoadedAttaches=t.waitForUploads=void 0,n=i(n);t.waitForUploads=function(e){return e.scheduler.waitForAll()};t.getLoadedAttaches=function(e){return e.filter((function(e){return!!e.id}))};t.isUploadingAttachments=function(e){return e.scheduler.hasQueuedTasksOfType("upload_attachment")||e.scheduler.hasRunningTasksOfType("upload_attachment")};t.preprocess=function(e){var t=e.logScope.scope("preprocess"),n=e.get("body.html");return e.preprocessor.execute(n,e).then((function(t){t.text&&e.set("body.html",t.text)})).catch((function(e){t.add("error",e)}))};t.handleEvent=function(e,t){if(t.model instanceof n.default&&"destroy"===t.type)e.removeAttachment(t.model)};t.resetSpaceLeft=function(e){return e.set("space_left",e.MAX_SPACE_LEFT)};t.getMode=function(e){switch(!0){case e.is("source.draft"):return r.FormDataModes.draft;case e.is("source.forward"):return r.FormDataModes.forward;case e.is("source.reply"):return r.FormDataModes.reply;case e.is("source.schedule"):return r.FormDataModes.schedule;default:return r.FormDataModes.new}}}.apply(t,r))||(e.exports=a)},74285:function(e,t,n){var r,a;r=[n(96596),n(42423),n(24003)],void 0===(a=function(e,t,n){"use strict";var r=n({order:["inline"],processors:{inline:function(e){var t=e.text||"",n=e.formData;return new Promise((function(e){var r=[];n.attachments.forEach((function(e){if(e.isInline())if(e.get("url")){var n=a(e.get("url")),i="cid:"+e.get("content_id");if(t.match(n))t=t.replace(n,i);else if(!t.includes(i))r.push(e)}})),r=r.map((function(e){return n.removeAttachment(e)})),e(Promise.all(r).then((function(){return{text:t,formData:n}})))}))},calls:function(t){var n=t.text||"",r=t.formData,a=[],i=e.scope("mail.MessageFormData.Preprocessor");return new Promise((function(e){if(-1!==n.indexOf("data-call-url"))try{var t=document.createElement("div");t.innerHTML=n;for(var s=t.querySelectorAll("a[data-call-url]"),o=s.length,c=0;c<o;c++){var u=s[c];if(u.hasAttribute("data-call-url"))a.push(u.getAttribute("href")),u.removeAttribute("data-call-url")}if(a.length)n=t.innerHTML,r.set("calls",a)}catch(e){i.add("error",err)}e({text:n,formData:r})}))}},constructor:function(){this.logScope=e.scope("mail.MessageFormData.Preprocessor")},getOrder:function(e){return this["order:"+e]||this.order},execute:function(e,t,n){var r=this.getOrder(n),a=this.logScope.scope("execute",r),i=r.map(function(e){if(!this.processors[e])a.add("error: "+e+" is not implemented");return this.processors[e]}.bind(this)),s={text:e,formData:t};return i.reduce(function(e,t,n){var i=r[n];return e.then((function(e){return s=e,a.add("start: "+i),t(s)})).catch((function(e){return a.add("error: "+i,e),Promise.resolve(s)}))}.bind(this),Promise.resolve(s))},setup:function(e){this.order=e.order||this.order,this.processors=Object.assign({},this.processors,e.processors||{}),["order:save","order:send"].forEach(function(t){if(e.hasOwnProperty(t))this[t]=e[t]}.bind(this))}}),a=function(e){var t=e||"";return t=(t=t.replace(/&/g,"&amp;")).replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!<>\|\:])/g,"\\$1"),new RegExp(t,"gi")};return r.version="0.4.1",r}.apply(t,r))||(e.exports=a)},20509:function(e,t,n){var r,a,i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}c((r=r.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[2&o[0],a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},o=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,a=0,i=t.length;a<i;a++)if(r||!(a in t)){if(!r)r=Array.prototype.slice.call(t,0,a);r[a]=t[a]}return e.concat(r||Array.prototype.slice.call(t))},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(14091),n(39783),n(50),n(83327),n(92042),n(6116)],void 0===(a=function(e,t,n,r,a,u,l,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeSubjectFromAttachments=t.getFrom=t.create=t.getAttachmentsMoreText=t.getFwdMessage=void 0,r=c(r),a=c(a),l=c(l),d=c(d);t.getFwdMessage=function(e,t){return"Fwd: ".concat(e).concat(t>1?" (+".concat(t-1,")"):"")};t.getAttachmentsMoreText=function(e){return" и ещё ".concat(e)};var f=function(e,t){var i=e.mode,s=void 0===i?"new":i,o=e.forward,c=e.signature,l=void 0===c?"":c,f=e.subject,h=void 0===f?"":f,p=e.correspondents,m=void 0===p?{}:p,_=e.body,v=void 0===_?"":_,g=new r.default({correspondents:m,subject:h,body:{html:"".concat(v).concat(n.NEW_LINE).concat(n.NEW_LINE).concat(l)}});if(o)o.forEach((function(e){return t.addAttachment(a.default.from(new d.default(e)))})),g.set("subject",t.getFwdMessage(o[0].name,o.length));return u.constructFormData.call(this,{formData:t,model:g,mode:s,signature:l,body:v})};t.create=function(e,t){return i(this,void 0,void 0,(function(){var a,o,c,d,h,p,m,_,v,g,y,b,E,T,A,S=this;return s(this,(function(w){return a=t.mode,o=void 0===a?"new":a,c=t.signature,d=void 0===c?"":c,h=t.body,p=void 0===h?"":h,m=t.collectors,_=void 0===m?[]:m,v=t.aliases,g=void 0===v?[]:v,y=t.from,b=void 0===y?"":y,E=t.remove_emoji_opts,T=void 0===E?{}:E,A=t.source,[2,new Promise((function(a,c){return i(S,void 0,void 0,(function(){var i,h,m;return s(this,(function(s){switch(s.label){case 0:if(e.set("from",b),n.IS_MANUAL_MODE[o])e.set("features.subject_from_attachments",!0);if(o===n.FormDataModes.new)return a(f.call(this,t,e)),[2];if(i=t.model,h=i.get("folder"),i instanceof l.default)i=i.isDataFully()?i.get("messages").eq(0):new r.default({id:i.get("expand"),folder:h});i.set("remove_emoji_opts",T),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,i.fetch()];case 2:return m=s.sent(),a(u.constructFormData.call(this,{formData:e,model:m,source:A,mode:o,folder_id:h,email:b,signature:d,body:p,collectors:_,aliases:g})),[3,4];case 3:return s.sent(),c(),[3,4];case 4:return[2]}}))}))}))]}))}))};t.getFrom=function(e,t,n){var r=e.get("correspondents.to"),a=e.get("correspondents.cc"),i=o(o([],r,!0),a,!0);if(!i.length)return{email:n};t=t.filter((function(e){return e.canSendLetters()}));if(i.some((function(e){return e.email===n})))return{email:n};else return i.find((function(e){return t.find((function(t){return t.getEmail()===e.email}))}))||{email:n}};t.makeSubjectFromAttachments=function(e){var t=e.get("features.max_shown_attachments"),n=e.attachments,r=n.filter((function(e){return!e.isInline()})).pluck("name").slice(0,t).join(", ");if(n.length>t){var a=e.getAttachmentsMoreText(e.attachments.length-t);r="".concat(r).concat(a)}e.set("subject",r)}}.apply(t,r))||(e.exports=a)},96897:function(e,t,n){var r,a,i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])if(Object.prototype.hasOwnProperty.call(t,a))e[a]=t[a];return e}).apply(this,arguments)},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[2&o[0],a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(66423),n(50),n(14091),n(936),n(39783),n(14091),n(33368)],void 0===(a=function(e,t,n,r,a,u,l,d,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reattach=t.restoreExpiredAttachmentsProcess=t.restoreExpiredAttachments=t.keepalive=t.isKeepaliveExpired=t.clearKeepaliveInterval=t.setKeepaliveInterval=void 0,n=c(n),r=c(r),a=c(a),u=c(u),l=c(l),f=c(f);t.setKeepaliveInterval=function(e){e._attachmentsKeepaliveId=setInterval((function(){return(0,t.keepalive)(e)}),1e3*e.transport.attachmentsKeepalive)};t.clearKeepaliveInterval=function(e){return clearInterval(e._attachmentsKeepaliveId)};t.isKeepaliveExpired=function(e){var t=e._lastKeepaliveDate,n=e.transport.attachmentsKeepaliveExpirationTime;return(new Date).getTime()-t>n};t.keepalive=function(e){return s(void 0,void 0,void 0,(function(){var t,r,a,i,s,c,u;return o(this,(function(o){switch(o.label){case 0:if(t=e.transport,r=e.attachments,a=e.uid,i=e.logScope,!r.length)return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,t.getRPC().post(t.getUrl("attachmentsKeepalive"),{message_id:a})];case 2:return o.sent(),e._lastKeepaliveDate=(new Date).getTime(),i.add("keepalive ok"),[3,4];case 3:if(s=o.sent(),c=(null==s?void 0:s.get("status"))===Number(n.default.statuses.invalid),u="attachments_not_found"===(null==s?void 0:s.get("body.message_id.error")),c&&u)e._attachmentsNotFound=!0,i.add("keepalive attachments_not_found fail");return i.add("keepalive fail"),[3,4];case 4:return[2,Promise.resolve()]}}))}))};t.restoreExpiredAttachments=function(e){return s(void 0,void 0,void 0,(function(){return o(this,(function(n){if(e.isKeepaliveExpired())return[2,e.keepalive().then((function(){return e.__restoreExpiredAttachments()}))];else return[2,(0,t.restoreExpiredAttachmentsProcess)(e)]}))}))};t.restoreExpiredAttachmentsProcess=function(e){return s(void 0,void 0,void 0,(function(){var t,n,r,a;return o(this,(function(i){switch(i.label){case 0:if(t=!1,e.getMode()!==d.FormDataModes.new)t=!0;if(!(t&&e._restoreExpiredAttachments&&e._attachmentsNotFound))return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,e.reattach({sync_attachments:!1,reset_attachments:!1,sync_space_left:!0})];case 2:if(n=i.sent(),r=n.reattached,a=n.okay_files,!r||!a)return[2];else return a.forEach((function(t){var n=e.attachments.find((function(e){return e.get("origin_id")===t.get("origin_id")}));if(n)n.set("id",t.get("id"))})),e.logScope.add("restore expired attachments ok"),e._attachmentsNotFound=!1,e._lastKeepaliveDate=(new Date).getTime(),[3,4];case 3:return i.sent(),e.logScope.add("restore expired attachments fail"),[3,4];case 4:return[2,Promise.resolve()]}}))}))};t.reattach=function(e,t){return s(void 0,void 0,void 0,(function(){var n,r,a;return o(this,(function(s){if(n={source_model:null,sync_space_left:!0,sync_attachments:!0,reset_attachments:!1,attachmentFilter:null},!t)t=n;if(t instanceof l.default)t=i(i({},n),{source_model:t});if(r=Promise.resolve(t.source_model),a=null,!t.source_model){if(!(a=e.get("source.".concat(e.getMode()))))return[2,Promise.resolve({reattached:!1,space_left:e.get("space_left")})];r=l.default.findOne(a)}return[2,r.then((function(n){return h(e,n,t)}))]}))}))};var h=function(e,t,n){return s(void 0,void 0,void 0,(function(){var i,s,c,l,d,h,p,m,_,v;return o(this,(function(o){if(i=Promise.resolve({formData:e,okay_files:new r.default.List,error_files:new r.default.List,space_left:e.get("space_left"),reattached:!1}),!t)return a.default.reattachUpdate(this,i,n),[2,i];if("reply"===e.getMode()&&!t.hasInlineAttachments()&&!n.force)return[2,i];if(s=t.get("attaches.list.length"),c=t.getInlineAttachments(),l=e.logScope,d=e.uid,h=e.transport,p=e.scheduler,m=l.scope("reattach",{count:s,inline_count:c.count,form_uid:d,message_id:t.id}),t.hasAttachments()||t.hasInlineAttachments())return _={transport:h,logScope:m,message:t,formData:e,options:n},v=new u.default(_),p.start(v,{execution:f.default.EXECUTION_QUEUED}),[2,v.asPromise().then((function(e){return e}))];else return[2,i]}))}))}}.apply(t,r))||(e.exports=a)},64810:function(e,t,n){var r,a,i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}c((r=r.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[2&o[0],a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},o=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,a=0,i=t.length;a<i;a++)if(r||!(a in t)){if(!r)r=Array.prototype.slice.call(t,0,a);r[a]=t[a]}return e.concat(r||Array.prototype.slice.call(t))},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(39783),n(14091)],void 0===(a=function(e,t,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeTemplate=t.fetchTemplate=t.applyTemplate=void 0,n=c(n);t.applyTemplate=function(e,n){return i(void 0,void 0,void 0,(function(){var r;return s(this,(function(a){switch(a.label){case 0:return[4,(0,t.fetchTemplate)(n)];case 1:return r=a.sent(),[2,(0,t.mergeTemplate)(e,r)]}}))}))};t.fetchTemplate=function(e){var t=e.id,r=e.folder,a=e.remove_emoji_opts,i=void 0===a?{}:a;return n.default.findOne({id:t,folder_id:r,remove_emoji_opts:i})};t.mergeTemplate=function(e,t,n){if(void 0===n)n={subject:!0,correspondents:!0,attachments:!0,body:!1};var a=e.is("source.template");e.set("source.template",t.get("id"));var i=n.body,s=n.subject,c=n.correspondents,u=n.attachments;if(i)e.set("body",t.get("body")+e.get("body"));if(s)e.set("subject",t.get("subject"));if(c)!function(e,t){var n;if(null===(n=t.get("correspondents.from"))||void 0===n?void 0:n.length)e.set("correspondents.from",t.get("correspondents.from"));r.COMMON_CORRESPONDENT_FIELDS.forEach((function(n){var r={};o(o([],e.get("correspondents.".concat(n)),!0),t.get("correspondents.".concat(n)),!0).forEach((function(e){r[e.email]=e})),e.set("correspondents.".concat(n),Object.values(r))}))}(e,t);if(u)!function(e,t,n){if(n)e.attachments.reset();e.reattach({source_model:t,reset_attachments:!0,sync_attachments:!0,sync_space_left:!0,force:!0}).then((function(n){e.emit("template-applied",{templateId:t.get("id"),data:n})}))}(e,t,a);return{usedTemplateBefore:a,template:t}}}.apply(t,r))||(e.exports=a)},32666:function(e,t,n){var r,a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(s=0)),s;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[2&o[0],a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(6===o[0]&&s.label<a[1]){s.label=a[1],a=o;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};void 0===(r=function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cancelTranslationSave=t.saveTranslation=t.clearTranslation=t.translateBody=t.translateSubject=t.translate=void 0;var n=[{search:/&quot;/g,replace:'"'},{search:/&#39;/g,replace:"'"},{search:/&#92;/g,replace:"\\"},{search:/&lt;/g,replace:"<"},{search:/&gt;/g,replace:">"},{search:/&amp;/g,replace:"&"}];t.translate=function(e,n){return Promise.all([(0,t.translateSubject)(e,n),(0,t.translateBody)(e,n)])};t.translateSubject=function(e,t){return a(void 0,void 0,void 0,(function(){var r,a,s;return i(this,(function(i){switch(i.label){case 0:if(r=Date.now(),!e.get("subject"))return e.meta("subjectLastTranslation",{time:r,params:t}),e.set("translatedSubject",""),[2,Promise.resolve("")];else return[4,e._translateAttr(t,"subject")];case 1:if(a=i.sent(),a=String(a),n.forEach((function(e){var t=e.search,n=e.replace;return a=a.replace(t,n)})),s=e.meta("subjectLastTranslation"),(s?s.time:0)<=r)e.meta("subjectLastTranslation",{time:r,params:t}),e.set("translatedSubject",a);return[2,Promise.resolve(e.get("translatedSubject"))]}}))}))};t.translateBody=function(e,t){return a(void 0,void 0,void 0,(function(){var n,r,a;return i(this,(function(i){switch(i.label){case 0:return n=Date.now(),[4,e._translateAttr(t,"body.html")];case 1:if(r=i.sent(),a=e.meta("bodyLastTranslation"),(a?a.time:0)<=n)e.meta("bodyLastTranslation",{time:n,params:t}),e.set("translatedBody",r);return[2,e.get("translatedBody")]}}))}))};t.clearTranslation=function(e,t){if(void 0===t)t=!1;e.set("translatedBody","",t),e.set("translatedSubject","",t)};t.saveTranslation=function(e,n){var r=e.get("body.html"),a=e.get("subject");e.set("body.html",e.get("translatedBody"),n),e.set("subject",e.get("translatedSubject"),n),(0,t.clearTranslation)(e),e.meta("lastTranslationBackup",{body:r,subject:a}),e.meta("lastSavedTranslation",e.meta("bodyLastTranslation").params)};t.cancelTranslationSave=function(e){var t=e.meta("lastTranslationBackup"),n=t.body,r=t.subject;e.set("body.html",n),e.set("subject",r)}}.apply(t,[n,t]))||(e.exports=r)},14091:function(e,t,n){var r,a,i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])if(Object.prototype.hasOwnProperty.call(t,a))e[a]=t[a];return e}).apply(this,arguments)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(50),n(96911)],void 0===(a=function(e,t,n,r){"use strict";t.FormDataModes=void 0,n=s(n),r=s(r);var a,o=/^(<br\/>)+|(<br\/>)+$/g;!function(e){e.smartreply="smartreply",e.replyall="replyall",e.reply="reply",e.new="new",e.template="template",e.draft="draft",e.schedule="schedule",e.forward="forward"}(a=t.FormDataModes||(t.FormDataModes={}));var c=function(e){if(e){var t=e.name,n=e.email;return t?"".concat(t," <").concat(n,">"):n}},u={reattachErrorsAddId:function(e,t){var n,r=null,a=e+";";if(0==(null===(n=t.origin_id)||void 0===n?void 0:n.indexOf(a)))r=t.origin_id.slice(a.length);else r=t.origin_id;return i(i({},t),{id:r})},reattachNormalize:function(e,t){switch(t.type){case n.default.TYPE_CLOUD_STOCK:return function(e){var t,n,r,a;if(e.origin_id)r=(t=e.origin_id.split(":"))[0],a=t[1];else if(e.origin)r=e.origin;if(e.attach){var i=(null===(n=e.attach)||void 0===n?void 0:n.id.split(":"))||[],s=i[0],o=i[1];e.attach.file_id=o,e.attach.bundle_id=s}return Object.assign({},e.attach,{origin_id:a,origin_bundle_id:r,type:e.type})}(t);default:return function(e,t){var n=Object.assign({},t.attach,{origin_id:t.origin_id,type:t.type}),r=t.origin_id?e.list[t.origin_id]:null;if(r)n=Object.assign(n,r);return n}(e,t)}},reattachUpdate:function(e,t,n){var r=Promise.resolve(t);if(!t.reattached)return r;var a=t.okay_files,i=t.space_left;if(n.reset_attachments)e.attachments.reset();if(n.sync_attachments){if(n.attachmentFilter)a=a.filter((function(e){var t=n.attachmentFilter(e);if(!t)i-=e.get("size");return t}));e.attachments.set(a)}if(n.sync_space_left)if(void 0!==i)e.set("space_left",i);return r},COMMON_CORRESPONDENT_FIELDS:["to","cc","bcc"],FormDataModes:a,HEADER_FORWARD_MESSAGE:"X-SenderField-FwdMsg",HEADER_REPLY_MESSAGE:"X-SenderField-ReMsg",IS_MANUAL_MODE:{new:!0,draft:!0,template:!0},NEW_LINE:"<div><br/></div>",bodyHtmlPreparingReplace:function(e,t,n){return e.replace(/__BODY_HTML_PLACEHOLDER__/,(function(){return t})).replace(/(<base .*?>)/gm,"").replace(/((<br\/>)*)?__SIGN_HTML_PLACEHOLDER__((<br\/>)*)?/,(function(e){return(t=e,t.replace(o,(function(e){return function(e){return e.replace(/<br\/>/g,"<div><br/></div>")}(e)}))).replace(/__SIGN_HTML_PLACEHOLDER__/,(function(){return n}));var t}))},encodePlaceholder:function(e){return e.replace(/__SIGN_HTML_PLACEHOLDER__/g,"&#95;&#95;SIGN&#95;HTML&#95;PLACEHOLDER&#95;&#95;")},toAddress:c,toAddresses:function(e){if(void 0===e)e=[];return e.map(c).join(", ")},createTemporaryLetterUid:function(){var e=0;return((0,r.default)()+(0,r.default)()).replace(/[a-z-]/g,(function(t){if("-"===t)t="";return++e%2?t:t.toUpperCase()})).substr(0,32)},version:"0.1.0"};return t.default=u,u}.apply(t,r))||(e.exports=a)},20848:function(e,t,n){var r,a;r=[n(38495),n(25709),n(50),n(66423),n(83260)],void 0===(a=function(e,t,n,r,a){"use strict";var i=function(e){var t=(e=(e=e||"").split(/\n/)[0]).trim().split(";");if(t.length&&("-"===t[t.length-1].charAt(0)||!/^\w/.test(t[0])||t.length<1||t.length>2))return!1;else return!0},s=function(e){var t=(e=(e=e||"").split(/\n/)[0]).trim().split(";");if(1===t.length)return{hash:t[0]};else return{hash:t[0],size:+t[1]}},o=e.extend({className:"mail.MessageFormData.CloudStockUploadTask",type:"upload_attachment",xhr:null,transport:null,didStart:function(){this.transport=this.context.transport;var e=this.context.attachment;if(!e.isCloud()){if(e.destroyed)throw new Error("Attachment destroyed");this._addAttachAsLink(e).then(this.resolve,this.reject)}else{var t=e.get("cloud_id");if(t)e.set("id",t);this.resolve()}},willCancel:function(){var e=this.xhr;if(e&&e.abort)e.abort()},_downloadToUploader:function(n,r){var o=this.context.logScope,c=this.transport.getRPC(),u=this.transport.get("use-s3");return new Promise(function(l,d){var f=n.getBlob();if(f){var h=u?r:r+"?x-email="+c.setup("email")+"&cloud_domain=2",p=this.context.skipFromQueue;t.workflow({url:h,files:{file:f},loggerMeta:o.meta,force:p},function(t,r){var c;if(t.fileprogress=function(t){this.emit(e.EVENT_PROGRESS,[this,t])}.bind(this),t.filecomplete=function(e,t){o.add("onfilecomplete",{error:e,xhr:t});var a=t.responseText;if(t.status<200||t.status>=300)r(t);else if(i(a)||u){var c=s(a);if(void 0===c.size)c.size=n.get("size");if(u)c.hash="none";var l={readyState:t.readyState,response:t.response,responseType:t.responseType,status:t.status,statusText:t.statusText,getAllResponseHeaders:function(){return t.getAllResponseHeaders()},getResponseHeader:function(e){return t.getResponseHeader(e)},responseText:JSON.stringify(c)};return void r(l)}r(t)},c=new XMLHttpRequest,this.xhr=c,c.open("PUT",t.url,!0),c.withCredentials=!0,u)c.withCredentials=!1,c.setRequestHeader("Content-Disposition","attachment; filename*=UTF-8''"+encodeURIComponent(n.get("name")));c.upload.onprogress=a.throttle(t.fileprogress),c.onreadystatechange=function(){if(4===c.readyState)t.filecomplete(void 0,c)};try{c.send(t.files.file)}catch(e){t.filecomplete(e,c)}}.bind(this)).then((function(e){l(e.body)}),(function(e){d(e)}))}else d(new Error("Должен же быть блоб"))}.bind(this))},_addAttachAsLink:function(e){var t=this.context.logScope.scope("addAttachAsLink",{cid:e.cid,size:e.get("size"),type:e.get("type")});return e.set("type",n.TYPE_CLOUD_STOCK),this._getCloudStore().then(function(n){return t.add("successGetBundleId",n.bundleId),this._downloadToUploader(e,n.loaderUrl).then((function(e){return{hash:e.hash,size:e.size,bundleId:n.bundleId}}))}.bind(this)).then(function(n){return t.add("successLoadFile",{size:n.size,hash:n.hash,bundleId:n.bundleId}),this._addAttachmentAsLink(e.get("name"),n.size,n.hash,n.bundleId)}.bind(this)).then((function(n){t.add("successLoadFile",{id:n.result.file_id,bundleId:n.bundle_id}),e.set({id:n.bundleId+":"+n.result.file_id,file_id:n.result.file_id,bundle_id:n.bundleId,duedate:n.result.duedate})})).catch((function(e){return t.add("AddingAttachAsLinkFailed",e),Promise.reject(e)}))},_addAttachmentAsLink:function(e,t,n,r){var a=this.transport.getRPC(),i={name:e,size:t,hash:n,bundle_id:r},s=this.context.logScope.scope("attachmentAsLinkAddToBundle",i),o=this.context.skipFromQueue;return a.post(this.transport.getUrl("addAttachmentAsLink"),i,{force:o}).then((function(e){return s.add("successRequest",e),{result:e.body,bundleId:r}})).catch((function(e){return s.add("failRequest",e),Promise.reject(e)}))},_getCloudStore:function(){var e=this.transport.get("cloudStore"),t=this.transport.get("use-s3"),n=this.transport.getRPC(),r=this.context.logScope.scope("getCloudStore");if(e)return r.add("find cloud store in cache",e),Promise.resolve(e);var a=t?"request to get s3 store":"request to get cloud store";r.add(a);var i=this.context.skipFromQueue;return n.post(this.transport.getUrl("createCloudAttachment"),{message_id:this.context.messageId},{force:i}).then(function(e){var n={bundleId:e.body.bundle_id,loaderUrl:e.body.loader_url};if(!n.bundleId||!n.loaderUrl)return Promise.reject(new Error("Ожидался и bundleId и loaderUrl"));if(r.add("succes request",n),!t)this.transport.set("cloudStore",n);return n}.bind(this)).catch((function(e){return r.add("failed request",e),Promise.reject(e)}))}});return o.version="0.2.1",o.isValidCloudStockResponse=i,o.parseCloudStockResponse=s,o}.apply(t,r))||(e.exports=a)},3911:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(38495),n(1751)],void 0===(a=function(e,t,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n=i(n),r=i(r);var a=n.default.extend({className:"mail.MessageFormData.MailUploadTask",type:"upload_attachment",xhr:null,transport:null,didStart:function(){var e=this.context,t=e.attachment,n=e.transport,r=e.loadBlobCloud;if(this.transport=n,t.destroyed)throw new Error("Attachment destroyed");if(r)return this.loadToBlobCloud();else return this.loadMessagesAttaches()},getTransport:function(e,t){var a=this,i=this.context.logScope;return function(s,o){i.add("upload",e),s.fileprogress=function(e){a.emit(n.default.EVENT_PROGRESS,[a,e])},s.filecomplete=function(e,t){var n;i.add("onfilecomplete",{error:e});var r=t.status,a=t.responseText,s=(null===(n=t.getResponseHeader)||void 0===n?void 0:n.call(t,"content-type"))||"application/json";o({status:r,responseText:a,contentType:s})},s.uploadMethod=t,a.xhr=r.default.upload(s)}},loadMessagesAttaches:function(){var e=this.context,t=e.attachment,n=e.logScope,r=e.skipFromQueue,a=e.messageId,i=this.transport.getRPC(),s={email:i.setup("email"),token:i.setup("token"),message_id:a},o={files:{file:t.getBlob()},loggerMeta:n.meta,force:r,transport:this.getTransport(s,"POST")};return i.call(this.transport.getUrl("addAttachment"),s,o).then(this.resolve,this.reject)},loadToBlobCloud:function(){var e=this,t=this.transport.getRPC(),n=this.context,r=n.attachment,a=n.messageId,i=n.skipFromQueue,s=n.logScope,o=n.blobCloudPath,c={email:t.setup("email"),token:t.setup("token"),message_id:a},u={files:{file:r.getBlob()},loggerMeta:s.meta,force:i,dataType:"text/plain",type:"PUT",transport:this.getTransport(c,"PUT")};return t.call(o,c,u).then((function(n){s.add("blob_upload",n);var o=n.get("responseText"),c={email:t.setup("email"),token:t.setup("token"),hash:o,file_name:r.get("name"),message_id:a};return t.post(e.transport.getUrl("addAttachmentHash"),c,{force:i}).then(e.resolve,e.reject)})).catch(this.reject)},willCancel:function(){var e,t=this.xhr;null===(e=null==t?void 0:t.abort)||void 0===e||e.call(t)}});a.version="0.2.0",t.default=a}.apply(t,r))||(e.exports=a)},81465:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(50),n(38495),n(20848),n(36822)],void 0===(a=function(e,t,n,r,a,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Canceller=void 0,n=i(n),r=i(r),a=i(a),s=i(s);var o=function(){function e(){this.cancelled=!1,this.request=null}return e.prototype.set=function(e){if(this.request=e,this.cancelled)this.cancel()},e.prototype.cancel=function(){var e;this.cancelled=!0,null===(e=this.request)||void 0===e||e.abort()},e}();t.Canceller=o;var c=r.default.extend({className:"mail.MessageFormData.OversizeCloudUploadTask",type:"upload_attachment",didStart:function(){var e=this,t=this.context,i=t.attachment,s=t.callbacks,o=t.logScope;this.loadToCloud().then((function(e){return i.set({cloud_id:e.id,type:n.default.TYPE_CLOUD,name:e.get("name"),size:e.get("size"),content_type:e.getExtension()}),i})).then((function(t){var n=t.get("size");o.add("addOversizeCloudAttachment",{cid:t.cid,type:t.get("type"),cloud_id:t.get("cloud_id"),content_id:t.get("content_id"),size:n});var i=new a.default({attachment:t,isLink:!0,messageId:e.uid,transport:e.transport,callbacks:s,logScope:o,size:n});i.on(r.default.EVENT_REJECT,e.reject),i.on(r.default.EVENT_RESOLVE,e.resolve),i.start()})).catch((function(t){o.add("oversize_cloud_attach_err",{err:t}),e.reject(t)}))},loadToCloud:function(){var e=this,t=this.context,n=t.loadToCloud,a=t.skipFromQueue;return this.canceller=new o,n({onUploadProgress:function(t){e.emit(r.default.EVENT_PROGRESS,[e,t])},canceller:this.canceller,force:a}).then((function(e){var t=e.size,n=e.path,r=e.name;return new s.default({name:r,size:t,id:n})}))},willCancel:function(){var e;null===(e=this.canceller)||void 0===e||e.cancel()}});c.version="0.0.1",t.default=c}.apply(t,r))||(e.exports=a)},936:function(e,t,n){var r,a,i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};r=[n,t,n(38495),n(14091),n(50)],void 0===(a=function(e,t,n,r,a){"use strict";n=i(n),r=i(r),a=i(a);var s=n.default.extend({className:"mail.MessageFormData.ReattachTask",type:"reattach",xhr:null,transport:null,didStart:function(){this.transport=this.context.transport;var e=this.context.formData,t=this.context.message,n=this.context.logScope,i=this.context.options,s=t.getInlineAttachments();return this.transport.getRPC().call(this.transport.getUrl("reattach"),{message_id:e.uid,forwarded_id:t.id,folder_id:t.get("folder")},{loggerMeta:n.meta}).then((function(o){n.add("reattach.results",{okay_files:o.get("body.okay_files.length"),error_files:o.get("body.error_files.length")});var c=o.get("body.okay_files").map(r.default.reattachNormalize.bind(this,s)).filter((function(e){if("inline"===e.type)if(!e.content_id)return n.add("reattach.afterNormalize.lostContentId",{attach:e}),!1;else return e.content_id;return!0})),u=o.get("body.error_files").filter((function(e){return!!e.error})).map(r.default.reattachErrorsAddId.bind(this,t.id)),l=o.get("body.error_files").map(r.default.reattachNormalize.bind(this,s));n.add("reattach.afterNormalize",{okay_files:c,error_files:l});var d={formData:this,okay_files:new a.default.List(c),error_files:new a.default.List(l),errors:u,space_left:o.get("body.space_left"),reattached:!0};return r.default.reattachUpdate(e,d,i),d})).then(this.resolve,this.reject)}});return s.version="0.1.0",t.default=s,s}.apply(t,r))||(e.exports=a)}}]);