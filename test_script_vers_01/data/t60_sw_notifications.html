
		var __GLOBAL_SW_BOX_CONFIG__ = {"xray":{"xrayRadarUrl":"/api/v1/utils/xray","defaultParams":{"p":"octavius"},"o_ss":"6379.w"},"network-cache":{"key":"octavius","obsoleteKeys":[],"resources":[{"mask":"/hashed/.+\\.min\\.js","immutable":true},{"mask":"/pkgs/.+\\.js","immutable":true},{"mask":"/hb/e\\.mail\\.ru/.+\\.js","immutable":true}],"disabled":true,"debug":true}};
		!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var t=function(){return(t=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function e(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))}function n(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function r(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],a=0,s=i.length;a<s;a++,o++)r[o]=i[a];return r}var o=[],i={maxSize:500,getLog:function(){return Array.prototype.slice.call(o,0)},clear:function(){o=[]}};var a={log:function(){try{(console.debug||console.log).apply(console,arguments)}catch(t){}},error:function(){try{console.error.apply(console,arguments)}catch(t){}},warn:function(){try{console.warn.apply(console,arguments)}catch(t){}}};function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function c(t){return t&&"object"===s(t)&&!u(t)}function u(t){return"[object Array]"===Object.prototype.toString.call(t)}function l(){for(var t={},e=0;e<arguments.length;++e){var n=arguments[e];for(var r in n)t[r]&&c(t[r])&&c(n[r])?t[r]=l(t[r],n[r]):t[r]=n[r]}return t}function f(t){var e=encodeURIComponent(JSON.stringify(t));return{size:e.length,raw:e}}var d=["p","email","split","utm","r","pgid","o_ss","o_v"],h=!1;function p(){this._batchesByUrls={},this._timeoutId=null,this._config={maxBatchSize:6e4,maxChunkSize:4e3,timeout:1e3,idle:!1},"undefined"!=typeof window&&window.addEventListener("beforeunload",this.process.bind(this,!0))}function g(t){return"s".concat(t,"s").replace(/s+/g,"s").replace(/^s$/g,"")}function v(t){for(var e in t)void 0!==t[e]&&null!==t[e]||delete t[e];return t}function m(t,e){for(var n=-1,r=0;r<t.length;r++)if(e===t[r]){n=r;break}return n}p.prototype.setConfig=function(t){if(!h)return t.timeout=Math.max(1e3,t.timeout||0),this._config=l(this._config,t),void(h=!0);var e=[];for(var n in t)n in this._config?e.push(n):this._config[n]=t[n];e.length&&a.warn("Queue config field(s) "+e.join(", ")+" are already set and can't be modified")},p.prototype.getConfig=function(){return l(this._config,{})},p.prototype.push=function(t,e){!function(t){for(o.push(t);o.length>i.maxSize;)o.shift()}(e);var n=t+"/batch?"+p._buildQueryString(e),r=f(e=p._stringifyParams(e));if(r.size+2>this._config.maxBatchSize)a.error("Radar #"+e.uid+" body is too long: "+r.raw);else{this._batchesByUrls[n]||(this._batchesByUrls[n]=[[]]);var s,c=this._batchesByUrls[n];for(s=0;s<c.length;++s){var u=c[s];if(f(u.concat([e])).size<=this._config.maxBatchSize){u.push(e);break}}s===c.length&&c.push([e]),this._timeoutId||"function"!=typeof setTimeout||(this._timeoutId=setTimeout(this.process.bind(this),this._config.timeout))}},p.prototype.process=function(t){for(var e in clearTimeout(this._timeoutId),this._timeoutId=null,this._batchesByUrls){for(var n=this._batchesByUrls[e],r=0;r<n.length;++r)this._send(e,n[r],t);delete this._batchesByUrls[e]}},p.prototype.isIdle=function(){return this._config.idle},p._buildQueryString=function(t){for(var e=[],n=0;n<d.length;++n){var r=d[n],o="string"==typeof t[r]?t[r]:JSON.stringify(t[r]);delete t[r],void 0!==o&&o.length&&e.push(encodeURIComponent(r)+"="+encodeURIComponent(o))}var i=[];for(var a in t.baseQuery)i.push(a);i=i.sort();for(var s=0;s<i.length;++s){var c=i[s];e.push(encodeURIComponent(c)+"="+encodeURIComponent(t.baseQuery[c]))}return delete t.baseQuery,e.join("&")},p.prototype._send=function(t,e,n){var r={url:t,data:"batch="+encodeURIComponent(JSON.stringify(e)),type:"POST",async:!0};if(!this._config.idle)if("undefined"!=typeof XMLHttpRequest||navigator.sendBeacon)if(n&&window.navigator.sendBeacon)window.navigator.sendBeacon(r.url,r.data);else try{var o=new XMLHttpRequest;if("function"==typeof this._config.beforeSend&&!this._config.beforeSend(o,r))return void o.abort();o.open(r.type,r.url,r.async),o.withCredentials=!0,o.send(r.data)}catch(t){a.error("xray.send failed:",t)}else fetch(t,{method:r.type,body:r.data})},p._stringifyParams=function(t){var e={};for(var n in t)"i"!==n?e[n]="string"==typeof t[n]?t[n]:JSON.stringify(t[n]):e.i=p._stringifyI(t.i);return e},p._stringifyI=function(t){var e=[];for(var n in t){var r=t[n];e.push(n+":"+r)}return e.join(",")};var y=0,_=["radarPrefix","split","r","pgid","utm","o_ss","o_v"],w=!1,b=new p,P="xray_rlog_dot_error",C="xray_rlog_msg_abs",k="xray_too_long",S="xray_not_configured";function x(){this._config={xrayRadarUrl:"https://xray.mail.ru",pgid:(Date.now()+Math.random()).toString(36),radarPrefix:"",r:"undefined"!=typeof document&&document.referrer||"",defaultParams:{p:"mail",t_feature:"",v:1,skipdwh:!1}}}x.prototype.logger=i,x.prototype.setConfig=function(t,e){t=t||{},w&&this._deleteProtectedParams(t),this.unsafeSetConfig(t,e)},x.prototype.unsafeSetConfig=function(t,e){w=!0,(t=t||{}).split&&(t.split=g(t.split)),t.defaultParams&&t.defaultParams.i&&(t.defaultParams.i=this._formatIntervals(t.defaultParams.i),delete this._config.defaultParams.i),this._config=e?t:l(this._config,t),t.gaTrackingId&&this._initGA(t.gaTrackingId)},x.prototype._deleteProtectedParams=function(t){for(var e=0;e<_.length;++e)delete t[_[e]];return t},x.prototype.addSplit=function(t){this._config.split=g("".concat(this._config.split||"","s").concat(t))},x.prototype.getConfig=function(){return l(this._config,{})},x.prototype.getTotalSended=function(){return y},x.prototype.setQueueConfig=p.prototype.setConfig.bind(b),x.prototype.getQueueConfig=p.prototype.getConfig.bind(b),x.prototype.getInstanceCopy=function(){var t=new x;return w=!1,t.setConfig(this._config,!0),t},x.prototype.send=function(t,e,n){this._send(t,e,n,!0)},x.prototype._send=function(t,e,n,r){if(r&&!w&&t!==S){var o=e||{};o.t=t,this._logOwnError(o,S),a.warn("Your xray instance is not configured")}if(e=l(e||{},{}),this._config.middlewares)for(var i=0;i<this._config.middlewares.length;i++){var s=(0,this._config.middlewares[i])(t,e,n);t=s.t,e=s.params,n=s.ga}t=u(t)?t.join("_"):t,e.i&&(e.i=this._formatIntervals(e.i)),(e=l(this._config.defaultParams,this._config.expid?{dwh:{expid:this._config.expid}}:{},e,{t:t,split:this._config.split,r:this._config.r,pgid:this._config.pgid,utm:this._config.utm,o_ss:this._config.o_ss,o_v:this._config.o_v,baseQuery:this._config.baseQuery,uid:y++})).skipdwh&&e.dwh&&delete e.dwh;for(var c=[e.t_feature,this._config.radarPrefix],f=0;f<c.length;++f)c[f]&&(e.t=c[f]+"_"+e.t);delete e.t_feature;try{e=this._validateParams(e,r)}catch(t){return a.log("xray",e.uid,e),void a.error(t.message)}if(this._config.verbose&&a.log("xray",e.uid,e.t,e,n?"GA: "+!!n:void 0),b.push(this._config.xrayRadarUrl,e),!0!==n||this._config.gaTrackingId){var d="string"==typeof n?n:this._config.gaTrackingId;if(n&&d&&!b.isIdle()){if(e.i){for(var h in e.i)this._sendGA(t+"_"+h,e.i[h],d);return}this._sendGA(t,e.v,d)}}else a.error("Radar #"+e.uid+": no GA tracking id specified")},x.prototype.sendImmediately=function(t,e,n){this.send(t,e,n),b.process()},x.prototype.addMiddleware=function(t){this._config.middlewares||(this._config.middlewares=[]),-1===m(this._config.middlewares,t)&&this._config.middlewares.push(t)},x.prototype.removeMiddleware=function(t){if(this._config.middlewares){var e=m(this._config.middlewares,t);e>-1&&this._config.middlewares.splice(e,1)}},x.prototype._sendGA=function(t,e,n){"function"!=typeof gtag&&this._initGA(n);var r=t.split(/_/g),o=r[1]||r[0],i=r[1]?r[0]:"",a=r.slice(2).join("_"),s={value:e,send_to:n};i&&(s.event_category=i),a&&(s.event_label=a),gtag("event",o,s)},x.prototype._initGA=function(t){if(!window.gtag){var e=document.createElement("script");e.src="https://www.googletagmanager.com/gtag/js?id="+t,e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e),window.dataLayer=window.dataLayer||[],window.gtag=function(){window.dataLayer.push(arguments)},gtag("js",new Date)}gtag("config",t,{send_page_view:!1})},x.prototype._logOwnError=function(t,e,n){var r="xray_err",o=r,i=t.p;if(i){if(i.length+r.length+1>32){var a=32-r.length-1;i=i.slice(0,a)}o="".concat(i,"_").concat(r)}var s=t.t;s.length>64&&(s=s.slice(0,64)),this._send(e,{skipdwh:!0,rlog:o,rlog_message:{t:s,err:e,value:n}},!1,!1)},x.prototype._validateParams=function(t,e){(t=v(t)).rlog&&-1!==t.rlog.indexOf(".")&&(e&&this._logOwnError(t,P,t.rlog),a.error("Radar #".concat(t.uid,": rlog can not contain file extension")),delete t.rlog,delete t.rlog_message),t.rlog&&t.rlog_message||(t.rlog_message&&(e&&this._logOwnError(t,C),a.error("Radar #".concat(t.uid,": rlog_message would not be sent without rlog"))),delete t.rlog,delete t.rlog_message);var n={32:[t.p,t.rlog],64:[t.p+"_"+t.t]};for(var r in t.i)n[32].push(r),n[64].push(t.p+"_"+t.t+"_"+r);for(var o in n)for(var i=n[o],s=0;s<i.length;++s)if(i[s]&&i[s].length>o)throw e&&this._logOwnError(t,k,i[s].slice(0,o)),new Error("Radar #".concat(t.uid,": value is too long: ").concat(n[o][s])+" (len: ".concat(i[s].length,", limit: ").concat(o,")"));return t},x.prototype._formatIntervals=function(t){if(c(t))return t;var e={};if(u(t)){for(var n=0;n<t.length;++n){var r=t[n].split(":");e[r[0]]=+r[1]||this._config.defaultParams.v}return e}if("string"==typeof t){var o=t.split(",");return this._formatIntervals(o)}};var E=new x;function j(t,e){for(var n=t.split("&"),r=n[0],o={},i=1;i<n.length;++i){var a=n[i].split("="),s=decodeURIComponent(a[0]),c=decodeURIComponent(a[1]);try{c=JSON.parse(c)}catch(t){}o[s]=c}(e=e||{}).immediately?E.sendImmediately(r,o,e.ga):E.send(r,o,e.ga)}j.setConfig=function(t){E.setConfig(v({verbose:t.verbose,pgid:t.pgid,split:t.split,xrayRadarUrl:t.xrayRadarUrl||t.XRAY_RADAR_URL,radarPrefix:t.radarPrefix||t.RadarPrefix,utm:t.utm,o_ss:t.o_ss,o_v:t.o_v,baseQuery:t.baseQuery,gaTrackingId:t.gaTrackingId||t.GA_TRACKING_ID,defaultParams:t.defaultParams||v({p:t.project,email:t.ActiveEmail})})),E.setQueueConfig(v({maxBatchSize:t.MAX_BATCH_SIZE,maxChunkSize:t.MAX_CHUNK_SIZE,beforeSend:t.beforeSend,timeout:t.timeout,idle:t.idle}))},j.getConfig=x.prototype.getConfig.bind(E),j.addSplit=x.prototype.addSplit.bind(E),j.unsafeSetConfig=x.prototype.unsafeSetConfig.bind(E),j.setQueueConfig=x.prototype.setQueueConfig.bind(E),j.getQueueConfig=x.prototype.getQueueConfig.bind(E),j.getTotalSended=x.prototype.getTotalSended.bind(E),j.send=x.prototype.send.bind(E),j.sendImmediately=x.prototype.sendImmediately.bind(E),j.getInstanceCopy=x.prototype.getInstanceCopy.bind(E),j.addMiddleware=x.prototype.addMiddleware.bind(E),j.removeMiddleware=x.prototype.removeMiddleware.bind(E);var A="assertion error",I="error";function O(t){return!!t&&"object"==typeof t}function M(t){return"string"==typeof t}function R(t,e){if(void 0===e&&(e=I),"number"!=typeof t)throw new Error("assertion error: "+e)}function T(t,e){if(void 0===e&&(e=I),"string"!=typeof t)throw new Error("assertion error: "+e)}function N(t,e){if(void 0===e&&(e=I),!t||"object"!=typeof t)throw new Error("assertion error: "+e)}function U(t,e){if(void 0===e&&(e=I),N(t),!Array.isArray(t))throw new Error("assertion error: "+e)}function D(t,e,n){void 0===n&&(n=I),void 0!==t&&e(t,n+" optional")}var L=["code","errno","syscall"];function B(e){if(!e||"object"!=typeof e)return e;if("function"==typeof e.toJSON)return e.toJSON();for(var n=t(t({},e),{name:e.name,message:e.message,stack:e.stack}),r=0,o=L;r<o.length;r++){var i=o[r];n[i]=e[i]}return n}function q(t){var e=function(t){try{return null===__GLOBAL_SW_BOX_CONFIG__||void 0===__GLOBAL_SW_BOX_CONFIG__?void 0:__GLOBAL_SW_BOX_CONFIG__[t]}catch(t){}}(t);return e&&"object"==typeof e?e:null}var z={body:!0,subject:!0,name:!0,title:!0,titlePlural:!0,description:!0};function J(t){if(M(t)||Array.isArray(t))return t.length}function F(t,e){return void 0===e&&(e=0),t&&O(t)?("function"==typeof t.toLogJSON&&(t=t.toLogJSON()),Object.keys(t).reduce((function(n,r){var o=t[r];if("object"==typeof o){if(z[r])return n[r]=J(o),n;if(e<=10&&(!o||!o.nodeType))return n[r]=F(o,e+1),n}else n[r]=z[r]?J(o):o;return n}),{})):t}function G(t,r,o){var i=this;return t().then((function(t){return e(i,void 0,void 0,(function(){var e,i;return n(this,(function(n){switch(n.label){case 0:if(!t)return[2,r];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,o(t)];case 2:return e=n.sent(),t.close(),[2,e];case 3:throw i=n.sent(),t.close(),i;case 4:return[2]}}))}))}))}var H=function(){},W=function(){function t(t,e){this._from=t,this._maxEntries=e,this._lastWritePromise=Promise.resolve()}return Object.defineProperty(t.prototype,"lastWritePromise",{get:function(){return this._lastWritePromise},enumerable:!1,configurable:!0}),t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{this._log.apply(this,r(["error"],t)).catch((function(){return ct("db_logger_error")}))}catch(t){ct("db_logger_error")}},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{this._log.apply(this,r(["log"],t)).catch((function(){return ct("db_logger_error")}))}catch(t){ct("db_logger_error")}},t.prototype.getAllEntries=function(){var t=this;return G((function(){return t._initialize()}),[],(function(t){return new Promise((function(e,n){var r=t.transaction("entries","readonly").objectStore("entries").index("by_ts").openCursor(null,"next"),o=[];r.onerror=n,r.onsuccess=function(){if(this.result){var t=this.result.value;delete t.id,o.push(t),this.result.continue()}else e(o)}}))}))},t.prototype.clear=function(){var t=this;G((function(){return t._initialize()}),void 0,(function(t){return t.transaction("entries","readwrite").objectStore("entries").clear(),Promise.resolve()}))},t.prototype._log=function(t){for(var e=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=H;return this._lastWritePromise=new Promise((function(t){o=t})),G((function(){return e._initialize()}),void 0,(function(r){var i=r.transaction("entries","readwrite").objectStore("entries"),a=i.index("by_ts"),s={id:[Math.random(),Math.random(),Math.random(),Math.random()].join("::"),from:e._from,level:t,ts:Date.now(),data:n};return i.put(s).onsuccess=function(){var t=e._maxEntries;a.count().onsuccess=function(){var e=this.result-t;e<=0?o():a.openCursor(null,"next").onsuccess=function(){this.result&&e>0?(e--,this.result.delete(),this.result.continue()):o()}}},e._lastWritePromise}))},t.prototype._initialize=function(){return new Promise((function(t,e){var n=indexedDB.open("sw-box.mail.ru/logging",1);n.addEventListener("upgradeneeded",(function(t){var e=n.result;0===t.oldVersion&&e.createObjectStore("entries",{keyPath:"id"}).createIndex("by_ts","ts",{unique:!1})})),n.addEventListener("success",(function(){t(n.result)})),n.addEventListener("error",(function(t){e(t)}))}))},t}();function Q(t){if(Array.isArray(t))return t.map((function(t){return Q(t)}));if(O(t)){for(var e={},n=0,r=Object.keys(t);n<r.length;n++){var o=r[n];e[o]=Q(t[o])}return e}return t}var X,$,K=function(){function t(t,e){this._from=t,this._maxEntries=e,this._entries=[]}return t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._log.apply(this,r(["error"],t))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._log.apply(this,r(["log"],t))},t.prototype.getAllEntries=function(){return Promise.resolve(this._entries)},t.prototype.clear=function(){this._entries.splice(0,this._entries.length)},t.prototype._log=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this._entries.push({ts:Date.now(),from:this._from,level:t,data:Q(e)}),this._entries.length>this._maxEntries&&this._entries.shift()},t}();!function(t){t.Memory="Memory",t.IndexedDB="IndexedDB"}(X||(X={}));var V,Y,Z,tt=[],et=!1;function nt(t){return t.map((function(t){return F(t)}))}var rt=new(function(){function t(){}return t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t=nt(t),$&&$.log.apply($,t)},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t=nt(t),$&&$.error.apply($,t);var n=t.find((function(t){return O(t)})),r=t.filter((function(t){return t!==n})),o=t[t.length-1],i=o.email||Y;O(o)&&o.silent||ct("push_error",{rlog:"sw-box",email:i,rlog_message:at(it({error:n,details:r},"logger().error"))})},t.prototype.getAllEntries=function(){return $?$.getAllEntries():Promise.resolve([])},t.prototype.clear=function(){$&&$.clear()},t}());function ot(){return rt}function it(t,e){return t instanceof Error?{from:V,type:e,error:B(t)}:t}function at(t){return{ua:navigator.userAgent,from:V,data:t}}function st(){return Z||j}function ct(t,e){et?st().send(t,e):tt.push({metricName:t,params:e})}var ut=new Set,lt=0;function ft(){clearInterval(lt),lt=setTimeout((function(){ut.clear()}),1e3)}function dt(t){return ut.add(t),ft(),Promise.reject(t)}function ht(){return self}var pt="sw-box.mail.ru";function gt(t){if(N(t),T(t.protocol,"protocol"),T(t.type,"type"),T(t.email,"email"),t.protocol!==pt)throw new Error(A)}function vt(t){if(gt(t),T(t.responseToken,"responseToken"),function(t,e){if(void 0===e&&(e=I),"boolean"!=typeof t)throw new Error("assertion error: "+e)}(t.support,"support"),"push-action-response"!==t.type)throw new Error(A)}function mt(t,e){var n=new Error(e.errorMessage);return fetch(t,e).catch((function(r){ot().error(n.message,{url:t,reason:r,stack:n.stack,detail:e.errorDetail},{silent:!0}),e.errorXRay&&ct(e.errorXRay)}))}function yt(t){try{return N(t),R(t.merged),N(t.description),R(t.description.length),!0}catch(t){return!1}}function _t(t,e,n){var r,o,i;void 0===t&&(t={});var a=null===(r=null==t?void 0:t.mail)||void 0===r?void 0:r.ack,s="ack"===e?null===(o=null==t?void 0:t.promo)||void 0===o?void 0:o.ack:null===(i=null==t?void 0:t.promo)||void 0===i?void 0:i.open,c=function(t,e){if(t){var r=new URL(t);return e&&r.searchParams.set("action",e),mt(r.toString(),{mode:"no-cors",errorXRay:"push_ack_error",errorMessage:"sendAck",errorDetail:{action:e,email:n}})}return Promise.resolve()};return c(a,e).then((function(){return c(s)}))}var wt=function(){function t(t,e,n,r,o,i){if(this._manager=t,this._context=r,this._rpc=o,this._analyticsURLs=i,this._id="pushnotification-"+Math.floor(1e7*Math.random())+"-"+Math.floor(1e7*Math.random()),this._actions={},this._awaitingResponse={},this._pushType=e,this._defaultAction=n.defaultAction,this._titlePlural=n.titlePlural,this._options=n,n.actions)for(var a=0,s=n.actions;a<s.length;a++){var c=s[a];this._actions[c.action]=c}}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),t.prototype.show=function(){var t,e=this,n=this._options;return(t={tag:n.tag},new Promise((function(e,n){setInterval((function(){return e([])}),1e3),ht().registration.getNotifications(t).then(e).catch(n)}))).then((function(t){var r,o,i,a,s,c,u,l,f,d=0!==t.length,h=d?t[t.length-1]:void 0,p=null==h?void 0:h.data,g=[null!==(o=n.description)&&void 0!==o?o:""],v=1;if(d)for(var m=0,y=t;m<y.length;m++){y[m].close()}if(yt(p)){var _=[];(v=p.merged+1)&&e._titlePlural&&(n.title=(s=v,c=e._titlePlural,u="count",l=s%100<=10||s%100>=20?s%10:0,2===(f=c.length||3)&&1===l?l=0:3===f&&l>1&&(l=l<5?2:0),(c[l]||c[l>1&&l<5?l:0]||c[l>1?1:0]).replace(new RegExp("\\{"+u+"\\}","g"),String(s)))),_.push(null!==(i=n.description)&&void 0!==i?i:"");for(var w=0,b=p.description;w<b.length;w++){var P=b[w];g.push(P),_.push(P)}n.body=_.join("\n")}var C={id:e._id,merged:v,description:g};return ot().log("NotificationImpl.show",n),ct("push_show",{dwh:(r={},r["type_"+e._pushType]=1,r["merged_"+e._pushType]=v,r),email:e._context.email}),(null===(a=e._context.config.counters)||void 0===a?void 0:a.show)&&mt(e._context.config.counters.show,{mode:"no-cors",errorMessage:"counters.show"}),ht().registration.showNotification(n.title,{tag:n.tag,data:C,icon:n.icon,body:n.body,silent:n.silent,timestamp:n.timestamp,dir:n.dir,badge:n.badge,image:n.image,lang:n.lang,renotify:n.renotify,requireInteraction:n.requireInteraction,vibrate:n.vibrate,actions:v>1?[]:n.actions})})).then((function(){return _t(e._analyticsURLs,"ack",e._context.email)})).then((function(){}))},t.prototype.close=function(){var t;ct("push_hide",{dwh:(t={},t["type_"+this._pushType]=1,t),email:this._context.email}),this._manager.closeById(this.id)},t.prototype.handleAction=function(t){var e,n,r=this;return void 0===t&&(t=this._defaultAction.action),ct("push_action",{dwh:(e={},e["type_"+this._pushType]=1,e["id_"+t.split(".").reverse()[0]]=1,e),email:this._context.email}),(null===(n=this._context.config.counters)||void 0===n?void 0:n.click)&&mt(this._context.config.counters.click,{mode:"no-cors",errorMessage:"counters.click"}),"open"===t||t.startsWith("mailapi.")?this._doAction(t).then((function(){return _t(r._analyticsURLs,"open",r._context.email)})).then((function(){})):Promise.race([this._findClientForAction(t),new Promise((function(t){return setTimeout(t,900)}))]).then((function(e){var n;return"function"==typeof e?null===(n=e())||void 0===n?void 0:n.then((function(){})):r._doAction(t)})).then((function(){return _t(r._analyticsURLs,"open",r._context.email)})).then((function(){}))},t.prototype._findClientForAction=function(t){var e=this;return ht().clients.matchAll({includeUncontrolled:!1,type:"window"}).then((function(n){return Promise.all(n.map((function(n){return e._requestClientPushAction(n,t)}))).then((function(t){return{responses:t,clients:n}}))})).then((function(n){for(var r=function(r){var o=n.clients[r];if(!n.responses[r])return"continue";var i={protocol:"sw-box.mail.ru",type:"push-action",email:e._context.email,pushType:e._pushType,action:t,pushContext:e._context};return{value:function(){var n,r="function"==typeof o.focus?o.focus():Promise.resolve();return o.postMessage(JSON.stringify(i)),ct("push_action_client",{dwh:(n={},n["type_"+e._pushType]=1,n["id_"+t.split(".").reverse()[0]]=1,n),email:e._context.email}),r.then((function(){}))}}},o=0;o<n.clients.length;o++){var i=r(o);if("object"==typeof i)return i.value}}))},t.prototype.handleMessage=function(t){var e=t.responseToken;if(this._awaitingResponse[e]){var n=this._awaitingResponse[e];delete this._awaitingResponse[e],n(t.support)}},t.prototype._requestClientPushAction=function(t,e){var n=this;return new Promise((function(r){var o=function(t){return t+"_request-"+Math.floor(1e7*Math.random())+"-"+Math.floor(1e7*Math.random())}(n._id),i=null,a=function(t){ot().log("NotificationImpl._requestClientPushAction","timeout"),delete n._awaitingResponse[o],clearTimeout(i),r(t)};n._awaitingResponse[o]=a,i=setTimeout((function(){return a(!1)}),850);var s={protocol:"sw-box.mail.ru",type:"push-action-request",email:n._context.email,pushType:n._pushType,action:e,responseToken:o};ot().log("NotificationImpl._requestClientPushAction",s.action),t.postMessage(JSON.stringify(s))}))},t.prototype._doAction=function(t){var e,n,r,o,i;if(ct("push_action_worker",{dwh:(e={},e["type_"+this._pushType]=1,e["id_"+t.split(".").reverse()[0]]=1,e),email:this._context.email}),!this._rpc)return this._doDefaultAction(t);switch((null!==(n=this._actions[t])&&void 0!==n?n:this._defaultAction).action){case"mailapi.message.markRead":return r=this._rpc,o=this._context,(i=new FormData).set("marks",JSON.stringify([{name:"unread",set:[],unset:[o.fetchedData.threadId]}])),r.fetch("/api/v1/threads/marks",{method:"POST",body:i});case"mailapi.message.remove":return function(t,e){var n=new FormData;return n.set("ids",JSON.stringify([e.fetchedData.threadId])),n.set("folder","500002"),t.fetch("/api/v1/threads/move",{method:"POST",body:n})}(this._rpc,this._context);default:return this._doDefaultAction(t)}},t.prototype._doDefaultAction=function(t){var e,n=null!==(e=this._actions[t])&&void 0!==e?e:this._defaultAction;return ht().clients.openWindow(n.url)},t}();function bt(t,e){var n=t;try{n=new URL(t).pathname}catch(t){}return(n=n.replace(/\//g,"-")).length>e&&(n=n.replace(/[eyuioa]/g,"")),n.length>e&&(n=n.substring(n.length-e,e)),n}function Pt(t,e,n){var r=0;return e.then((function(t){return r=t.status,t[n]()})).then((function(e){var n,o="status_",i="_"+e.status;return ct(["push_rpc"],{i:(n={},n["status_rpc_"+e.status]=1,n["status_http_"+r]=1,n[o+bt(t,32-o.length-i.length)+i]=1,n)}),e})).catch((function(e){return ct(["push_rpc_fail"]),ot().error("Push rpc failed",{url:t,type:n,reason:B(e)}),dt(e)}))}var Ct=function(){function e(t,e){this.urls=t,this._email=e,this._lastSDCRequestTs=0}return e.prototype.prepareRequest=function(e,n,r){var o;if(!e)throw new Error("Unreachable code");if("GET"===e.method){var i=new URL(n,this.urls.project);i.searchParams.append("email",this._email),i.searchParams.append("token",r),n=i.toString()}else e.body&&"string"!=typeof e.body?e.body instanceof FormData&&(e.body.set("email",this._email),e.body.set("token",r)):(e.body=JSON.stringify(t(t({},JSON.parse(null!==(o=e.body)&&void 0!==o?o:"{}")),{email:this._email,token:r})),e.headers={"content-type":"application/json"});return n},e.handleFetchResponse=function(t,e){return Pt(t,e,"json").then((function(t){if(!t||"object"!=typeof t||200!==t.status)throw t;return t}))},e.prototype.handleNoSDC=function(t,e,n){var r=this;if(O(t)&&403===t.status&&"nosdc"===t.body)return this.fetchSDC().then((function(){return r.fetch(e,n,{sdc:!1})}));throw ct(["push_nosdc_fail"]),t},e.prototype.fetchSDC=function(){var t=Date.now();if(t-this._lastSDCRequestTs<1e3)return Promise.reject(new Error("Too many SDC requests"));this._lastSDCRequestTs=t;var e=this.urls.sdc+"?from="+encodeURIComponent(this.urls.project)+"&dataType=jsonp&jsonp=JSONP_callback";return fetch(e,{method:"GET",mode:"no-cors",credentials:"include"}).then((function(){}))},e.prototype.fetchToken=function(){var t=this;return this.fetch(this.urls.token,{},{token:!1}).then((function(e){if(function(t){return O(t)&&O(t.body)&&"string"==typeof t.body.token}(e))return t._token=e.body.token,t._token;throw new Error("Invalid token response")}))},e.prototype.getToken=function(){return this._token?Promise.resolve(this._token):this.fetchToken()},e.prototype.fetch=function(t,n,r){var o,i,a,s,c,u=this;return n||(n={}),r||(r={}),n.mode=null!==(o=n.mode)&&void 0!==o?o:"no-cors",n.credentials=null!==(i=n.credentials)&&void 0!==i?i:"include",n.method=null!==(a=n.method)&&void 0!==a?a:"GET",r.sdc=null===(s=r.sdc)||void 0===s||s,r.token=null===(c=r.token)||void 0===c||c,!n.body||"string"==typeof n.body||n.body instanceof FormData?(r.token?this.getToken():Promise.resolve("")).then((function(e){return t=u.prepareRequest(n,t,e),fetch(t,n)})).then((function(n){return e.handleFetchResponse(t,Promise.resolve(n))})).catch((function(e){return(null==r?void 0:r.sdc)?u.handleNoSDC(e,t,n):Promise.reject(e)})).catch((function(e){return Pt(t,Promise.reject(e),"json")})):Promise.reject(new Error("Only string and FormData body supported"))},e}(),kt=function(){function t(){}return t.prototype.key=function(){return"rpc"},t.prototype.shouldInstall=function(t){return t.rpc.enabled},t.prototype.install=function(t,e){e.rpc.enabled&&(this.impl=new Ct(e.rpc.config.urls,e.email))},t.prototype.uninstall=function(){},t.prototype.fetch=function(t,e){var n;return(null===(n=this.impl)||void 0===n?void 0:n.fetch)?this.impl.fetch(t,e).catch((function(e){return ot().error("RPC fetch failed",{input:t,reason:B(e)}),dt(e)})):Promise.reject("Invalid MultiAuthRPC state")},t}(),St=function(){function t(){var t=this;this._notifications={},this.handleNotificationClick=function(e){if(yt(e.data.notification.data)){var n=t._notifications[e.data.notification.data.id];n&&e.waitUntil(n.handleAction(e.data.action?e.data.action:void 0).catch((function(){})).then((function(){n.close()})))}},this.handleNotificationClose=function(e){yt(e.data.notification.data)&&t.closeById(e.data.notification.data.id)},this.handleMessage=function(e){var n;try{var r=JSON.parse(e.data);vt(r),ot().log("NotificationManager.handleMessage",e.data);for(var o=Object.keys(t._notifications),i=0,a=o;i<a.length;i++){var s=a[i];null===(n=t._notifications[s])||void 0===n||n.handleMessage(r)}}catch(t){}}}return t.prototype.key=function(t){return"notification"},t.prototype.shouldInstall=function(t){return!0},t.prototype.install=function(t,e){this._rpc=t.componentsOfClass(kt)[0]},t.prototype.uninstall=function(){},t.prototype.closeById=function(t){var e=this._notifications[t];e&&(ht().registration.getNotifications().then((function(e){for(var n=0,r=e;n<r.length;n++){var o=r[n];yt(o.data)&&o.data.id===t&&o.close()}})),delete this._notifications[e.id])},t.prototype.open=function(t,e,n,r){var o=new wt(this,t,e,n,this._rpc,r);return this._notifications[o.id]=o,o.show()},t}(),xt="assert failed";function Et(t){if(!O(t)||"string"!=typeof t.action||"string"!=typeof t.title||"string"!=typeof t.url)throw new Error(xt)}function jt(t){if(!O(t)||"string"!=typeof t.title||"string"!=typeof t.icon||"string"!=typeof t.body||void 0!==t.silent&&"boolean"!=typeof t.silent||void 0!==t.tag&&"string"!=typeof t.tag||void 0!==t.timestamp&&"number"!=typeof t.timestamp||void 0!==t.dir&&("string"!=typeof t.dir||"auto"!==t.dir&&"ltr"!==t.dir&&"rtl"!==t.dir))throw new Error(xt);!function(t){if(!O(t)||"string"!=typeof t.action||"string"!=typeof t.url)throw new Error(xt)}(t.defaultAction)}function At(t){jt(t),function(t){if(!O(t)||void 0!==t.actions&&!Array.isArray(t.actions)||void 0!==t.badge&&"string"!=typeof t.badge||void 0!==t.image&&"string"!=typeof t.image||void 0!==t.lang&&"string"!=typeof t.lang||void 0!==t.renotify&&"boolean"!=typeof t.renotify||void 0!==t.requireInteraction&&"boolean"!=typeof t.requireInteraction||void 0!==t.vibrate&&!Array.isArray(t.vibrate))throw new Error(xt);if(void 0!==t.actions)for(var e=0,n=t.actions;e<n.length;e++)Et(n[e]);if(void 0!==t.vibrate)for(var r=0,o=t.vibrate;r<o.length;r++)R(o[r])}(t)}function It(t){var e,n;if(O(t))return T(t.account),D(t.type,T),D(t.template,At),D(t.ack,T),"string"==typeof t.hub_link&&(t.hub_link=JSON.parse(t.hub_link)),D(t.hub_link,N),D(null===(e=t.hub_link)||void 0===e?void 0:e.open,T),void D(null===(n=t.hub_link)||void 0===n?void 0:n.ack,T);throw new Error("Assertion error")}var Ot="•";function Mt(t,e){try{!function(t){It(t),T(t.id)}(e)}catch(t){return Promise.resolve(void 0)}return t.fetch("/api/v1/golang/messages/pushnotifications/message?uidl="+e.id+"&folder_id="+e.folder_id+"&htmlencoded=false").then((function(t){try{N(t);var e=t.body;return N(n=e),N(n.correspondents),U(n.correspondents.from),U(n.correspondents.to),U(n.correspondents.cc),U(n.correspondents.bcc),R(n.date),N(n.flags),T(n.folder),T(n.id),T(n.snippet),T(n.subject),T(n.thread_id),e}catch(t){return}var n}))}function Rt(t,e,n){var r=e;return Mt(t,n).then((function(t){return function(t,e){var n,r,o,i,a,s,c,u,l,f=null!=e?e:{},d=f.subject||t.emptySubjectText,h={title:t.defaultTitle,icon:t.defaultIcon,body:t.defaultBody,description:"",messageId:null!==(n=null==f?void 0:f.id)&&void 0!==n?n:"",threadId:null!==(r=null==f?void 0:f.thread_id)&&void 0!==r?r:"",folderId:null!==(o=null==f?void 0:f.folder)&&void 0!==o?o:""},p=function(t){var e;if(t&&t.length)return{displayName:null!==(e=t[0].name)&&void 0!==e?e:t[0].email,avatar:t[0].avatars.default}}(null!==(a=null===(i=null==f?void 0:f.correspondents)||void 0===i?void 0:i.from)&&void 0!==a?a:[]);return p&&(h.title=p.displayName,h.icon=null!==(s=p.avatar)&&void 0!==s?s:h.icon),(null===(c=null==f?void 0:f.flags)||void 0===c?void 0:c.attach)&&(d="📎 "+d),h.body=[d,Ot,null!==(u=f.snippet)&&void 0!==u?u:""].join(" "),h.description=[(null==p?void 0:p.displayName)?p.displayName+" "+Ot:"",d,Ot,null!==(l=f.snippet)&&void 0!==l?l:""].join(" ").slice(0,35),h}(r,t)}))}function Tt(t){function e(){}return e.validate=t.validate,e.format=t.format,e}var Nt={String:Tt({validate:function(t){if("string"!=typeof t)throw new Error("Bad format")},format:function(t,e){return String(e)}}),Number:Tt({validate:function(t){if("number"!=typeof t)throw new Error("Bad format")},format:function(t,e){return String(e)}}),Any:Tt({validate:function(t){return!0},format:function(t,e){return e=function(t,e){var n=e;if(n&&"object"==typeof n)for(var r=0;r<t.length;r++){var o=t[r],i=r===t.length-1,a=n[o];if(i)return a;if(!a||"object"!=typeof a)return;n=a}}(t,e),String(e)}})};function Ut(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function Dt(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return Ut(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ut(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}var Lt=/\u0024{[\w_.]+}/g;function Bt(t){return t.replace(/\\\$/g,"$$").replace(/\\{/g,"{")}function qt(t,e){var n,r,o,i=[],a=0;do{(n=Lt.exec(t))&&"string"==typeof n[0]&&("\\"===t.slice(n.index-1,n.index)?(r=t.slice(a,n.index-1),i.push(Bt(r)),i.push(t.slice(n.index,n.index+n[0].length))):function(){r=t.slice(a,n.index),i.push(Bt(r));var s=n[0].slice(2,n[0].length-1);o=function(t){var n=s.split("."),r=n[0],o=n.slice(1);return e[r].validate(t[r]),e[r].format(o,t[r])},i.push(o)}(),a=n.index+n[0].length)}while(null!==n);return r=t.slice(a),i.push(Bt(r)),function(t){return function(e){e=e&&"object"==typeof e?e:{};for(var n,r=[],o=Dt(t);!(n=o()).done;){var i=n.value;switch(typeof i){case"function":try{r.push(i(e))}catch(t){}break;case"string":default:r.push(i)}}return r.join("")}}(i)}function zt(t,e){if(Array.isArray(t))for(var n=t.length,r=0;r<n;r++)e(t[r],r);else for(var o=0,i=Object.keys(t);o<i.length;o++){var a=i[o];e(t[a],a)}}function Jt(t,e){var n=Array.isArray(t),r=n?[]:{};return zt(t,(function(t,n){var o;switch(typeof t){case"object":t&&(o=Jt(t,e));break;case"string":o=qt(t,e);break;default:o=t}"string"==typeof n?r[n]=o:Array.isArray(r)&&r.push(o)})),function(e){var o=n?[]:{};return zt(t,(function(t,n){var i=r[n],a=i;"function"==typeof i&&(a=i(e)),Array.isArray(o)?o.push(a):o[n]=a})),o}}function Ft(t){return Jt(t,{email:Nt.String,email_encoded:Nt.String,type:Nt.String,config:Nt.Any,payload:Nt.Any,fetchedData:Nt.Any})}var Gt,Ht=function(){function t(){this._templates={}}return t.prototype.key=function(t){return"pushmanager"},t.prototype.shouldInstall=function(t){return t.pushHandler.enabled},t.prototype.install=function(t,e){if(e.pushHandler.enabled&&(this._options=e,this._rpc=t.componentsOfClass(kt)[0],this._notifications=t.componentsOfClass(St)[0],e.pushHandler.templates))for(var n=0,r=Object.keys(e.pushHandler.templates);n<r.length;n++){var o=r[n],i=Ft(e.pushHandler.templates[o]);this._templates[o]=i,"default"===o&&(this._defaultTemplate=i)}},t.prototype.uninstall=function(){},t.prototype._readTemplate=function(t,e){var n,r,o;return M(e)?null!==(n=this._templates[e])&&void 0!==n?n:this._defaultTemplate:O(e)?null!==(r=function(t){try{return At(t),Ft(t)}catch(t){return}}(e))&&void 0!==r?r:this._defaultTemplate:(null==t?void 0:t.template)&&null!==(o=this._templates[t.template])&&void 0!==o?o:this._defaultTemplate},t.prototype.handlePush=function(t){var e,n,r=this,o=function(t){if(!t.data)throw new Error("No push data");var e=t.data.json();if(O(e.data)&&(e=e.data),M(e.template))try{e.template=JSON.parse(e.template)}catch(t){}return It(e),e.type||(e.type="mail"),e}(t);if(!this._options||!this._options.pushHandler.enabled)throw new Error("Push messaging disabled but received push event");if(ot().log("PushManager.handlePush",o),"string"==typeof o.type&&this._options.pushHandler.pushes&&this._options.pushHandler.pushes[o.type]&&o.account===this._options.email){var i=this._options.pushHandler.pushes[o.type],a=o.type,s=(e=o,{mail:(null==(n=this._options.analyticsRequest)?void 0:n.mail)?{ack:e.ack}:void 0,promo:(null==n?void 0:n.promo)?e.hub_link:void 0}),c=Promise.resolve(o),u=this._readTemplate(i,o.template);if(!u)throw new Error("No template for push");if(void 0!==i.dataFetcher){var l="PushManager.handlePush";c=c.then((function(){return r._fetchPushData(i,o).then((function(t){return ot().log(l,"data fetched",t),t})).catch((function(t){throw ct("push_error_datafetch"),ot().error(l,"data fetch error",it(t),{silent:!0},{email:o.account}),t}))}))}var f=c.then((function(t){var e,n,c,l={email:null!==(e=o.account)&&void 0!==e?e:"",email_encoded:encodeURIComponent(null!==(n=o.account)&&void 0!==n?n:""),type:a,config:i,payload:o,fetchedData:t},f=u(l);return f.title||(f.title=""),null===(c=r._notifications)||void 0===c?void 0:c.open(a,f,l,s)}));t.waitUntil(f)}},t.prototype._fetchPushData=function(t,e){return this._rpc?"mailMessageData"===t.dataFetcher?Rt(this._rpc,t,e):Promise.reject(new Error("Bad data fetcher")):Promise.reject(new Error("MultiAuthRPC is not initialized"))},t}(),Wt={rpc:{enabled:!1},pushHandler:{enabled:!1}},Qt=function(){function t(t,e){this.name=t,this.schema=e}return t.prototype._measureOpen=function(){},t.prototype._measureUpgradeNeeded=function(){},t.prototype.open=function(t){var e=this;this.db=void 0;var n=!1;return new Promise((function(r,o){var i=indexedDB.open(e.name,t);i.addEventListener("upgradeneeded",(function(t){var r,o=i.result;n=!0;for(var a=0,s=Object.keys(e.schema).map((function(t){return parseInt(t)})).sort((function(t,e){return t-e}));a<s.length;a++){var c=s[a];if(t.oldVersion>c)break;for(var u=0,l=Object.keys(null!==(r=e.schema[c])&&void 0!==r?r:{});u<l.length;u++){var f=l[u],d=e.schema[c][f];if(d.remove)o.deleteObjectStore(f);else{var h=o.createObjectStore(f,d.options);if(!d.indices)continue;for(var p=0,g=Object.keys(d.indices);p<g.length;p++){var v=g[p],m=d.indices[v];h.createIndex(v,m.keyPath,m.options)}}}}})),i.addEventListener("success",(function(){var t;(t=i.result).addEventListener("versionchange",(function(e){null===e.newVersion&&t.close()})),e.db=i.result,r(void 0)})),i.addEventListener("error",(function(t){o(t)})),i.addEventListener("blocked",(function(t){o(t)}))})).catch((function(t){return n&&e._measureUpgradeNeeded(),e._measureOpen(),Promise.reject(t)})).then((function(){n&&e._measureUpgradeNeeded(),e._measureOpen()}))},t.prototype.close=function(){this.db&&this.db.close(),this.db=void 0},t.prototype.transaction=function(t,e,n){var r=this;return this.db?n(this.db.transaction(t,e)).then((function(t){return r.close(),t})).catch((function(t){return r.close(),Promise.reject(t)})):Promise.reject(new Error("Database not opened"))},t.prototype.request=function(t){return new Promise((function(e,n){var r=t();r.addEventListener("success",(function(){e(r.result)})),r.addEventListener("error",(function(t){n(t)}))}))},t}();!function(t){t.Xray="xray"}(Gt||(Gt={}));var Xt=function(){function t(){}return t.prototype.loadConfig=function(t){var r=this;return this._initialize().then((function(o){return o.transaction(["configs"],"readonly",(function(i){return e(r,void 0,void 0,(function(){var e,r;return n(this,(function(n){switch(n.label){case 0:return e=i.objectStore("configs"),[4,o.request((function(){return e.get(t)}))];case 1:return(r=n.sent())&&"object"==typeof r?[2,r]:[2,{}]}}))}))}))}))},t.prototype.saveConfig=function(t,r){var o=this;return this._initialize().then((function(i){return i.transaction(["configs"],"readwrite",(function(a){return e(o,void 0,void 0,(function(){var e;return n(this,(function(n){switch(n.label){case 0:return e=a.objectStore("configs"),[4,i.request((function(){return e.put(r,t)}))];case 1:return n.sent(),[2]}}))}))}))}))},t.prototype._initialize=function(){var t=new Qt("sw-box.mail.ru/common-configs",{0:{configs:{}}});return t.open(1).then((function(){return t}))},t}(),$t="$default$",Kt="migrationTag.",Vt=function(){function r(){}return r.prototype.loadDefaultConfig=function(){return this.loadConfig($t)},r.prototype.loadConfig=function(r){var o=this;return this._initialize().then((function(i){return i.transaction(["configs"],"readonly",(function(a){return e(o,void 0,void 0,(function(){var e,o;return n(this,(function(n){switch(n.label){case 0:return e=a.objectStore("configs"),[4,i.request((function(){return e.get(r)}))];case 1:return(o=n.sent())?[3,3]:[4,i.request((function(){return e.get($t)}))];case 2:o=n.sent(),n.label=3;case 3:return[2,o?t(t({},o),{email:r}):void 0]}}))}))}))}))},r.prototype.saveConfig=function(r,o){var i=this;return this._initialize().then((function(a){return a.transaction(["configs"],"readwrite",(function(s){return e(i,void 0,void 0,(function(){var e,i;return n(this,(function(n){switch(n.label){case 0:return e=s.objectStore("configs"),i=t(t({},o),{email:r}),[4,a.request((function(){return e.put(i)}))];case 1:return n.sent(),r===$t?[3,3]:[4,a.request((function(){return e.put(t(t({},i),{email:$t}))}))];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))}))}))},r.prototype.loadAllEmails=function(){var t=this;return this._initialize().then((function(r){return r.transaction(["configs"],"readonly",(function(o){return e(t,void 0,void 0,(function(){var t;return n(this,(function(e){switch(e.label){case 0:return t=o.objectStore("configs"),[4,r.request((function(){return t.getAllKeys()}))];case 1:return[2,e.sent().filter((function(t){return t!==$t})).map((function(t){return String(t)}))]}}))}))}))}))},r.prototype.drop=function(){return t="sw-box.mail.ru/configs",new Promise((function(e,n){var r=indexedDB.deleteDatabase(t);r.onsuccess=function(){return e()},r.onerror=function(t){return n(t.error)},r.onblocked=function(){return n(new Error("Blocked"))}}));var t},r.prototype.removeUnusedEmails=function(t){var r=this;return this.loadAllEmails().then((function(o){for(var i={},a=0,s=t;a<s.length;a++){var c=s[a];i[c]=!0}var u=o.filter((function(t){return!i[t]}));return r._initialize().then((function(t){return t.transaction(["configs"],"readwrite",(function(t){return e(r,void 0,void 0,(function(){var e,r,o,i,a,s;return n(this,(function(n){for(e=t.objectStore("configs"),r=[],o=function(t){r.push(new Promise((function(n,r){var o=e.delete(t);o.onsuccess=n,o.onerror=r})))},i=0,a=u;i<a.length;i++)s=a[i],o(s);return[2,Promise.all(r)]}))}))}))})).then((function(){}))}))},r.prototype._initialize=function(){var t=new Qt("sw-box.mail.ru/configs",{0:{configs:{options:{keyPath:"email"},indices:{by_email:{keyPath:"email",options:{unique:!0}}}}}});return t.open(2).then((function(){return t}))},r.prototype.hasCustomTag=function(t){try{return"1"===localStorage.getItem(""+Kt+t)}catch(t){return!1}},r.prototype.setCustomTag=function(t){try{localStorage.setItem(""+Kt+t,"1")}catch(t){}},r.prototype.clearCustomTag=function(t){try{localStorage.removeItem(""+Kt+t)}catch(t){}},r.prototype.listCustomTags=function(){var t=[];try{for(var e=0;e<localStorage.length;e++){var n=localStorage.key(e);if("string"==typeof n&&n.startsWith(Kt)&&"1"===localStorage.getItem(n)){var r=n.slice(Kt.length);if(r.length>16&&(r=r.slice(0,Math.max(0,16)).replace(/,/g,"")),r&&(t.push(r),t.length>=32))return t}}}catch(t){}return t},r}();function Yt(){return $t}function Zt(t,e){var n=null;return function(r){return null===n&&(e.log("[fetch] request '"+t.url+"'"),n=fetch(t),r&&(n=n.then((function(n){return e.log("[caches] Put '"+t.url+"'"),ct("caches-fetch-put"),r.put(t,n.clone()).then((function(){return n})).catch((function(n){return e.log("[caches] Put '"+t.url+"' failed"),ct("caches-fetch-fail"),dt(n)}))})).then((function(n){return e.log("[caches] Put '"+t.url+"' successfully"),ct("caches-fetch-put-ok"),n})))),n.catch((function(e){return ot().error("Fetch with cache failed",{url:t.url,reason:B(e)},{silent:!0}),dt(e)}))}}function te(t){var e=Object.assign({},t),n=e.key,r=void 0===n?"sw-box":n,o=e.resources,i=void 0===o?[]:o,a=e.obsoleteKeys,s=e.disabled,c=void 0===s||s,u=e.debug,l=void 0!==u&&u?e.logger||console:{log:function(){},error:function(){}};l.log("Create NetworkCache (disabled: "+c+")");var f=[],d=[],h={};function p(){return caches.open(r).catch((function(t){return l.log("[caches] Open '"+r+"' failed"),ct("caches-open-failed"),Promise.reject(t)}))}function g(t){var e=[];void 0!==a&&e.push(function(t){return Array.isArray(t)||!0===t?caches.keys().then((function(e){return Promise.all(e.map((function(e){return!0===t||t.includes(e)?caches.delete(e).then((function(){return{key:e,deleted:!0}})):{key:e,deleted:!1}})))})).catch((function(t){return ct("caches-delete-failed"),[]})):Promise.resolve([])}(a)),e.length>0&&t.addEventListener("activate",(function(t){t.waitUntil(Promise.all(e))}))}function v(t){t.addEventListener("fetch",(function(t){var e=t.request,n=Zt(e,l),r=function(t){var e=t.url;return h[e]||d.find((function(t){return t.regexp.test(e)}))}(e);r&&!c?(t.respondWith(p().then(function(t,e){return function(n){return n.match(t).then((function(r){return e.log("[caches] Match for '"+t.url+"' "+(r?"exists":"not exists")),ct("caches-match-"+(r?"exists":"not exists")),[n,r]})).catch((function(n){return e.log("[caches] Match for '"+t.url+"' failed:",n),ct("caches-match-failed"),dt(n)}))}}(e,l)).then((function(t){var e=t[0];return t[1]||n(e)})).catch((function(t){return ot().error("Cache pull or fetch failed",{url:e.url,reason:B(t)},{silent:!0}),dt(t)}))),r.immutable||t.waitUntil(p().then(n).catch((function(t){return ot().error("Cache invalidate or fetch failed",{url:e.url,reason:B(t)},{silent:!0}),dt(t)})))):l.log("[caches] [fetch] Cache for '"+e.url+"' not found (rule: "+!!r+", disabled: "+c+")")}))}return i.forEach((function(t){!function(t){return!(!t||!("mask"in t))}(t)?(f.push(t),h[t.name]=t):d.push({regexp:new RegExp(t.mask),immutable:t.immutable})})),{connect:function(t){c||(!function(t){var e=[],n=f.filter((function(t){return t.preload}));n.length>0&&e.push(p().then((function(t){return t.addAll(n.map((function(t){return t.name}))).catch((function(t){l.log("[caches] Preload '"+r+"' failed:",t),ct("caches-preload-failed")}))}))),e.length>0&&t.addEventListener("install",(function(t){t.waitUntil(Promise.all(e))}))}(t),g(t),v(t))}}}var ee=function(){function e(t,e){var n=this;this._email=t,this._onConfigLoaded=e,this._components=[],this._installedComponents=[],this._storage=new Vt,this._loadConfigPromise=this._storage.loadConfig(this._email).then((function(t){return n._config=t,n._onConfigLoaded(),n._reinstallComponents(),t}))}return e.prototype.componentsOfClass=function(t){return this._installedComponents.filter((function(e){return e instanceof t}))},e.prototype.register=function(t){this._components.push(t)},e.prototype.patchConfig=function(e){var n=this;return this._loadConfigPromise=this._loadConfigPromise.then((function(r){var o;return n._config=t(t(t({},null!==(o=n._config)&&void 0!==o?o:Wt),null!=r?r:{}),null!=e?e:{}),n._reinstallComponents(),n._storage.saveConfig(n._email,n._config).then((function(){return n._config}))})),this._loadConfigPromise},e.prototype.callMethod=function(t,e){var n=this;return this._loadConfigPromise.then((function(){for(var r=0,o=n._components;r<o.length;r++){var i=o[r];"function"==typeof i[t]&&i[t](e)}}))},e.prototype._reinstallComponents=function(){for(var e=0,n=this._installedComponents;e<n.length;e++){(i=n[e]).uninstall()}if(this._installedComponents=[],this._config)for(var r=0,o=this._components;r<o.length;r++){var i;(i=o[r]).shouldInstall(this._config)&&(this._installedComponents.push(i),i.install(this,t(t({},this._config),{email:this._email})))}},e}(),ne=0,re=function(){function t(t,e,n){var r=this;this.type=t,this.data=e,this._id=ne++,this._resolve=function(){},this._reject=function(){},this._waitUntilCount=0,this._waitUntilResolve=function(){r._waitUntilCount--,r.tryResolve()},this._promise=new Promise((function(t,e){r._resolve=t,r._reject=e})),n&&n.waitUntil(this._promise)}return Object.defineProperty(t.prototype,"promise",{get:function(){return this._promise},enumerable:!1,configurable:!0}),t.prototype.waitUntil=function(t){var e=this;this._waitUntilCount++,t.then(this._waitUntilResolve).catch((function(t){if(e._rejectionHandler){var n=e._rejectionHandler(t);e._rejectionHandler=void 0,n instanceof Promise&&e.waitUntil(n)}else e._reject(t)}))},t.prototype.tryResolve=function(){this._waitUntilCount<=0&&this._resolve()},t.prototype.onReject=function(t){this._rejectionHandler=t},t}(),oe=function(){function e(e){var n=this;this._onManagerInit=e,this._scope=ht(),this._managers={},this._storage=new Vt,this._commonConfigs=new Xt,this._networkCache=te(q("network-cache")),this._onMessage=function(e){var r;try{var o=JSON.parse(e.data);switch(gt(o),o.type){case"config":!function(t){if(gt(t),N(t.config,"config"),U(t.emails,"emails"),"config"!==t.type)throw new Error(A)}(o);var i=t(t({},Wt),o.config);n._managers={},e.waitUntil(Promise.all([n._createManagerForEmail(o.email).patchConfig(i).then((function(){return n._createManagerForEmail(Yt()).patchConfig(i).then((function(){return n._storage.removeUnusedEmails(o.emails)}))})),o.config.xray?n._commonConfigs.saveConfig(Gt.Xray,o.config.xray):Promise.resolve()]));break;case"request-log-entries":!function(t){if(gt(t),"request-log-entries"!==t.type)throw new Error(A)}(o);var a=ot().getAllEntries().then((function(t){var n,r={protocol:pt,type:"log-entries",email:o.email,entries:t};null===(n=e.source)||void 0===n||n.postMessage(JSON.stringify(r),[])}));e.waitUntil(a);break;case"request-info":!function(t){if(gt(t),"request-info"!==t.type)throw new Error(A)}(o);var s={protocol:pt,type:"info",email:o.email,version:"0.15.0-fmail-18596.2"};null===(r=e.source)||void 0===r||r.postMessage(JSON.stringify(s),[]);break;case"clear-logs":!function(t){if(gt(t),"clear-logs"!==t.type)throw new Error(A)}(o),ot().clear()}}catch(t){return ct("push_error_msgformat"),void ot().error("Worker._onMessage","assertion fail",it(t),{silent:!0})}n._handleMessageEvent(e)},this._handlePushEvent=function(t){if(!t.data)return ct("push_nulldata"),ot().error("Worker._handlePushEvent","data is null"),void t.waitUntil(n._showDefaultNotification(t));var e=new re(t.type,t.data,t);try{var r=t.data.json(),o=r.data,i=r.account,a=O(o)?o.account:i;T(a),n._createManagerForEmail(a),e.onReject((function(r){return n._handlePushError(t,e.data,r)})),n._dispatchEvent(e,"handlePush"),e.tryResolve()}catch(r){n._handlePushError(t,e.data,r)}},this._handleNotificationEvent=function(t,e){var r=new re(e.type,{notification:e.notification,action:e.action},e);n._dispatchEvent(r,t)},this._handleMessageEvent=function(t){var e=new re(t.type,t.data,t);n._dispatchEvent(e,"handleMessage")},ht().addEventListener("message",this._onMessage),ht().addEventListener("push",this._handlePushEvent),ht().addEventListener("notificationclick",this._handleNotificationEvent.bind(this,"handleNotificationClick")),ht().addEventListener("notificationclose",this._handleNotificationEvent.bind(this,"handleNotificationClose")),ht().addEventListener("install",(function(){ht().skipWaiting()})),ht().addEventListener("activate",(function(t){t.waitUntil(ht().clients.claim())})),this._networkCache.connect(this._scope),this._commonConfigs.loadConfig(Gt.Xray).then((function(e){var n=st().getConfig(),r=t(t(t({},n),e),{defaultParams:n.defaultParams});st().setConfig(r)})).then((function(){et||(et=!0,st().send("init"),tt.length&&(tt.forEach((function(t){ct(t.metricName,t.params)})),tt.length=0))}))}return e.prototype._createManagerForEmail=function(t){var e=this;if(!this._managers[t]){var n=new ee(t,(function(){e._onManagerInit(n)}));this._managers[t]=n}return this._managers[t]},e.prototype._handlePushError=function(t,e,n){var r=this;ct("push_pusherror");var o=new re(t.type,e);this._storage.loadDefaultConfig().then((function(e){return e?(r._createManagerForEmail(e.email),o.waitUntil(r._showDefaultNotification(t,o)),o.promise):(ct("push_pusherror_nodefault"),void ot().error("Worker._handlePushError","push error nodefault",it(n),{silent:!0}))})).catch((function(t){ot().error("Worker._handlePushError","push error",it(t),it(n))}))},e.prototype._showDefaultNotification=function(t,e){var n=this;return this._storage.loadDefaultConfig().then((function(r){if(r){var o=new re(t.type,{json:function(){return{account:r.email,type:"default"}}},null!=e?e:t);n._dispatchEvent(o,"handlePush")}}))},e.prototype._dispatchEvent=function(t,e){ot().log("Worker._dispatchEvent",t.type);for(var n=0,r=Object.keys(this._managers);n<r.length;n++){var o=r[n];o!==Yt()&&t.waitUntil(this._managers[o].callMethod(e,t))}t.tryResolve()},e}();!function(e,n,r){var o,i;void 0===n&&(n=X.Memory),V=e;var a=q("xray"),s=r||a,c=null!==(i=null===(o=null==s?void 0:s.defaultParams)||void 0===o?void 0:o.p)&&void 0!==i?i:"sw-box",u=t(t({},JSON.parse(JSON.stringify(s))),{defaultParams:{p:c,t_feature:V.split("@")[0]}});switch((Z=j.getInstanceCopy()).unsafeSetConfig(u),n){case X.Memory:$=new K(V,200);break;case X.IndexedDB:$=new W(V,200)}$.log("Initialized logger for sw-box/"+V)}("worker@0.15.0-fmail-18596.2",X.IndexedDB),ht().onerror=function(t){var e=it(t.error,"error");ct(["onerror"]),ot().error(e)},ht().addEventListener("unhandledrejection",(function(t){var e=t.reason;if(!function(t){return ft(),ut.delete(t)}(e)){var n=it(e,"rejection");ct("unhandledrejection"),ot().error(n)}})),new oe((function(t){t.register(new kt),t.register(new St),t.register(new Ht)}))}));

	